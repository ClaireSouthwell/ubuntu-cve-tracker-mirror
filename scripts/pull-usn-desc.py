#!/usr/bin/env python
# Dumps the Ubuntu-Descriptions in a form suitable for a USN announcement
# Copyright (C) 2008 Canonical, Ltd.
# Author: Kees Cook <kees@ubuntu.com>
# License: GPLv3
import sys, os, debian.deb822
import textwrap

basedir = os.path.join(os.path.dirname(sys.argv[0]), '..')

descriptions = dict()
found = []

empty = set()
for cve in sys.argv[1:]:
    if cve == "--cve":
        continue
    filename = os.path.join(basedir, "active", cve)
    if os.path.exists(filename):
        chunks = debian.deb822.Deb822(file(filename))
        desc = chunks['Ubuntu-Description'].strip()
        if len(desc) == 0:
            disc = ''
            if chunks.has_key('Discovered-by'):
                disc = chunks['Discovered-by'].strip()
            desc = '[' + chunks['Description'].strip() + ']'
            if len(disc):
                desc = '%s:%s' % (disc,desc)
        desc = desc.replace('\n',' ').replace('   ',' ').replace('  ',' ')
        if len(desc) == 0:
            desc = "XXX-FIXME-%s-HAS-EMPTY-DESCRIPTION-XXX" % (cve)
    else:
        desc = "XXX-FIXME-%s-NOT-KNOWN-TO-TRACKER-XXX" % (cve)

    descriptions[cve] = desc
    found.append(cve)

reported = set()
for cve in found:
    if cve in reported:
        continue

    # Merge identical descriptions
    identical = []
    desc = descriptions[cve]
    for seen in sorted(descriptions):
        if descriptions[seen] == desc:
            identical.append(seen)
            reported.add(seen)

    if len(identical) != len(found):
        desc += " (%s)" % (", ".join(identical))

    desc = desc.encode("utf-8")
    print
    print textwrap.fill(desc,75)
