#!/usr/bin/env python
#
# This script produces plot data for how many source packages were fixed
# each month.
#
# Copyright (C) 2008 Canonical, Ltd
# Author: Kees Cook <kees@ubuntu.com>
# License: GPLv3
import sys, time, usn_lib, cve_lib

import pprint
pp = pprint.PrettyPrinter(indent=4)

config = cve_lib.read_config()
db = None
db_filename = config['usn_db_copy']
if len(sys.argv) > 1:
    db_filename = sys.argv.pop(1)
db = usn_lib.load_database(db_filename)

months = dict()
for usn in sorted(db.keys()):
    when = time.strftime('%Y-%m', time.gmtime(int(db[usn]['timestamp'])))
    for rel in db[usn]['releases']:
        months.setdefault(when, 0)
        if not db[usn]['releases'][rel].has_key('sources'):
            # Assume that the early USNs updated 1 srcpkg per release...
            months[when] += 1
            #pp.pprint(db[usn])
            continue
        for pkg in db[usn]['releases'][rel]['sources']:
            months[when] += 1

for month in sorted(months.keys()):
    print month, months[month]
