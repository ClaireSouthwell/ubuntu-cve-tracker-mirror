#!/usr/bin/env python
#
# This script reports how many CVEs and packages a given set of USNs
# touched.
#
# Copyright (C) 2008 Canonical, Ltd
# Author: Kees Cook <kees@ubuntu.com>
import sys, time, usn_lib

reverted = usn_lib.get_reverted()
db = None
db_filename = None
try:
    db_filename = sys.argv.pop(1)
    db = usn_lib.load_database(db_filename)
except:
    print >>sys.stderr, "Need to specify the database (eg database.pickle)"
    sys.exit(1)

cves = set()
srcs = set()
usns = sys.argv[1:]
for usn in usns:
    if not db.has_key(usn):
        print >>sys.stderr, "USN-%s not found in %s" % (usn, db_filename)
        continue
    for cve in db[usn]['cves']:
        if not cve.startswith('CVE-'):
            continue
        cves.add(cve)

    for rel in db[usn]['releases']:
        for pkg in db[usn]['releases'][rel]['sources']:
            srcs.add(pkg)

usn_count = len(usns)
cve_count = len(cves)
src_count = len(srcs)

def pluralize(count,singular,plural=None):
    if count == 1:
        return singular
    else:
        if plural:
            return plural
        else:
            return singular + "s"

#echo "$usns USN$usn_plural published covering $cves CVE$cve_plural in $pkgs supported package$pkg_plural"
print '%d %s plublished covering %d %s in %d supported %s' % \
    (
        usn_count, pluralize(usn_count,"USN"),
        cve_count, pluralize(cve_count,"CVE"),
        src_count, pluralize(src_count,"package")
    )
