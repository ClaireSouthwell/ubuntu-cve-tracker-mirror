#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of updated packages done as part of esm per release to
# prometheus for the KPIs
set -e

# shellcheck source=common.sh
. "$(dirname "${BASH_SOURCE[0]}")/common.sh"

# Since we process the actual CVE files we need to be in UCT itself not reviewed/
pushd "${UCT:-/home/ubuntu-security/git-pulls/cve-tracker}"

# use one timestamp for all data points
timestamp=$(date -u +%s)

for dist in $RELEASES; do
  # strip header off table - start at line 3
  report=$(./scripts/report-released-packages -e -r $dist | tail -n +3)
  total=$(echo "$report" | wc -l)
  ppa=$(echo "$report" | grep PPA | wc -l)
  universe=$(echo "$report" | grep ARCHIVE | wc -l)

  DATA="esm_total_source_package_updates $dist=$total"
  push_to_influx "$DATA" "$timestamp"

  DATA="esm_ppa_source_package_updates $dist=$ppa"
  push_to_influx "$DATA" "$timestamp"

  DATA="esm_universe_source_package_updates $dist=$universe"
  push_to_influx "$DATA" "$timestamp"
done
popd
