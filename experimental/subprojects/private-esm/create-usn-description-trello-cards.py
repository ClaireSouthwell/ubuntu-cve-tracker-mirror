# Consumes the output of ./esm-packages-usns.py and automatically creates
# trello cards for each USN that needs to be created.

# Instructions
#   1) $> pip3 install py-trello
#   2) $> git clone git@github.com:canonical/sec-trello-helper.git ~/git/sec-trello-helper
#   3) $> cd $UCT
#   4) $> python3 experimental/subprojects/private-esm/esm-packages-usns.py! ## Requires $UCT environment variable is set
#   5) $> python3 scripts/create-usn-description-trello-cards.py
#   6) $> rm pkgs-usn-info-new.json
# NOTE: The above assumes you've configured sec-trello-helper, which is lacking in documentation. Mainly, you need
#       to read the code and set up ~/.trello.conf
import json
import os
import subprocess

with open(os.path.expandvars("$UCT/pkgs-usn-info-new.json"), "r") as f:
    contents = f.read()

description_status = json.loads(contents)

pkgs_missing_descriptions = {}

for status in description_status:
    cves_missing_descriptions = []
    for cve, description in status["cves"].items():
        if not description:
            cves_missing_descriptions.append(cve)

    pkg = status["pkg"]
    for cve in cves_missing_descriptions:
        pkgs_missing_descriptions.setdefault(pkg, {}).setdefault("cves", []).append(cve)
        if cve in status["usns"]:
            pkgs_missing_descriptions[pkg].setdefault("usns", {}).setdefault(cve, [])
            pkgs_missing_descriptions[pkg]["usns"][cve] = (
                pkgs_missing_descriptions[pkg]["usns"][cve] + status["usns"][cve]
            )

# with open("report.json", "w") as f:
# json.dump(pkgs_missing_descriptions, f, indent=4)

for pkg, pkg_details in pkgs_missing_descriptions.items():
    card_description = ""
    for cve in pkg_details["cves"]:
        card_description += cve + "\n"
        for usn in pkg_details.get("usns", {}).get(cve, []):
            card_description += "\t" + usn + "\n"

        card_description += "\n"

    subprocess.run(
        [
            "python3",
            os.path.expanduser("~/git/sec-trello-helper/trello_helper/trello_helper.py"),
            "--board",
            "esm",
            "--lane",
            "Incoming",
            "--new",
            "%s USN Descriptions" % pkg,
            card_description,
        ]
    )
