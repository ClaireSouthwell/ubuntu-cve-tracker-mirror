#!/bin/bash
set -e
cd /home/ubuntu-security/graphing
REL=lucid
INDEX=11

COUNT=$(zgrep ^Package: /srv/archive.ubuntu.com/ubuntu/dists/$REL/{main,restricted}/binary-i386/Packages.gz | wc -l)
echo "$REL $INDEX $COUNT" > $REL.data

./plot.py | ./gnuplot
cp packages.png ~/public_html/graphs/

# Supported package counts
cat supported.data.template > supported.data
LAST=$(tail -n1 supported.data.template | cut -c2-)
echo $LAST $COUNT >> supported.data
./gnuplot < supported.plot
cp supported.png ~/public_html/graphs/

# Graph Open CVEs
NOW=$(date +'%Y-%m-%d')
CURRENT=$(echo -n "$NOW "; cd /home/ubuntu-security/bzr-pulls/cve-tracker; ./scripts/report-todo-plot -S)
cp CVE.data.template CVE.data
if [ $(date +%a) = "Sun" ] && ! grep -q ^"$NOW" CVE.data.template; then
    # Save weekly information as a snapshot
    echo "$CURRENT" >> CVE.data.template
fi
echo "$CURRENT" >> CVE.data
cat open-cves.plot | ./gnuplot
cp open-cves.png ~/public_html/cve/


XSTART=$(date -d "6 months ago" +%Y-%m-%d)
perl -p -e "s/^set xrange.*/set xrange [\"$XSTART\":]/;" open-cves-6mon.plot.template > open-cves-6mon.plot
cat open-cves-6mon.plot | ./gnuplot
cp open-cves-6mon.png ~/public_html/cve/
