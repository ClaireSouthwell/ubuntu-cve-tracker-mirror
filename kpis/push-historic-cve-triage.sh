#!/bin/bash
# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Generate and push to the influxdb the latest CVE triage data

set -e

# shellcheck source=common.sh
. "$(dirname "${BASH_SOURCE[0]}")/common.sh"

DAYS=$(get_missing_days_from_influx "historic_cve_triage")

echo "Generating and pushing data from last $DAYS days..."

while [[ $DAYS -gt 0 ]]; do
  QUERYDATE=$(date --date="today -$DAYS day" +%Y-%m-%d)
  DAYS_1=$((DAYS - 1))
  NEXTDAY=$(date --date="today -$DAYS_1 day" +%Y-%m-%d)
  TZ=UTC
  pushd "${UCT:-/home/ubuntu-security/git-pulls/cve-tracker}"
  DATA=$(git log --since "$QUERYDATE" --until "$NEXTDAY" -p | awk 'BEGIN { cve = ignored = 0 }
/^+Candidate:/ { cve++ }
/^+Patches_linux/ { packages["linux"]++ }
/^+Patches_/ { name=substr($1, 10, length($1)-10) ;
    if (name !~ /linux/) { packages[name]++ } }
/^+CVE/ { ignored++ }
END { print "historic_cve_triage cves=" cve ",ignored=" ignored ",packages=" length(packages) " " ; } ')
  popd
  # shellcheck disable=SC2086
  timestamp="$(date +%s -d $QUERYDATE)"
  push_to_influx "$DATA" "$timestamp"
  DAYS=$DAYS_1
done

