#!/bin/sh -e

# Author: Jamie Strandboge <jamie@ubuntu.com>
# Author: Kees Cook <kees@ubuntu.com>
# Author: Marc Deslauriers <marc.deslauriers@canonical.com>
# Author: Steve Beattie <sbeattie@ubuntu.com>
# Copyright (C) 2005-2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

#
# USAGE:
# scripts/html-report -d ~/public_html/cve
# scripts/html-report -d ~/public_html/cve -S
#
# '-d' specifies the output directory for the html
#

if [ "$1" = "-h" ]; then
cat << EOM
html-report -d <dir> [-S]
 -S show only official releases
 -d output directory
 -D support database
EOM
    exit 0
fi

support_db=
outdir=
table_args=
suffix=
ubuntu_table_exe="./scripts/ubuntu-table"

if [ -n "$UCT_REVIEWED" ]; then
    ubuntu_table_exe="$UCT_REVIEWED/scripts/ubuntu-table"
fi

while getopts "hSd:D:T:u:" opt
do
    case "$opt" in
        d) outdir="$OPTARG";;
        D) support_db="$OPTARG";;
        S) table_args="$table_args -S"
           suffix="-released"
           ;;
        T) table_args="$table_args $OPTARG";;
        u) ubuntu_table_exe="$OPTARG";;
        h) help ; exit 0;;
        ?) help;;
    esac
done
shift $(($OPTIND - 1))


# setup the output directory
mkdir "$outdir" 2>/dev/null || true
if [ ! -d "$outdir" ]; then
    echo "ERROR: '$outdir' does not exist"
    exit 1
fi

if [ -n "$UCT_REVIEWED" ] && [ -z "$UCT" ]; then
    echo "ERROR: must set UCT when using UCT_REVIEWED"
    exit 1
fi

# setup the temp directory
tmpdir=`mktemp -d`
trap "rm -rf ${tmpdir}" EXIT

header() {
    outfile="$1"
    cat > "$outfile" <<EOM
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Ubuntu CVE Tracker</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="author" content="Canonical Ltd, Kees Cook and Jamie Strandboge" />
<meta name="description" content="Ubuntu CVE Tracker" />
<meta name="copyright" content="Canonical Ltd" />
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<script src="./js/filter.js"></script>
<link rel="StyleSheet" href="toplevel.css" type="text/css" />
<link rel="StyleSheet" href="filter.css" type="text/css" />

</head>

<body>
<div id="container">
<h2>Ubuntu CVE Tracker</h2>
EOM
}

introduction() {
    outfile="$1"
    suffix="$2"
    cat >> "$outfile" <<EOM
<h3>Introduction</h3>
<p class="intro">Ubuntu tracks its security vulnerabilities via the <a
href="https://launchpad.net/ubuntu-cve-tracker">Ubuntu CVE Tracker</a>. 
This report is divided into the following sections:</p>
<ul>
  <li><a href="main${suffix}.html#main">Main</a> (supported by Canonical Ltd)</li>
  <li><a href="universe${suffix}.html#universe">Universe</a> (supported by the Ubuntu community)</li>
  <li><a href="partner${suffix}.html#partner">Partner</a> (supported by upstream vendor)</li>
</ul>

<p><a href="priority.html">Priority Color Key</a></p>

<div id="filter">
    <h3>Filters</h3>
    <select id="field-selector"></select>
    <div id="filter-criteria">
    </div>
    <button type="button" class="and_button" style="display: none">AND</button>
    <button type="button" class="or_button" style="display: none">OR</button>
    <div id="filter-button-div">
        <button type="button" id="filter-button">Filter</button>
        <button type="button" id="clear-filter-button">Clear Filter</button>
    </div>
</div>
EOM
}

footer() {
    outfile="$1"
    NOW=$(date -u +"%Y-%m-%d %R %Z")
    COMMIT=$(git rev-parse HEAD)
    cat >> "$outfile" <<EOM
<p class='note'><a href="https://code.launchpad.net/~ubuntu-security/ubuntu-cve-tracker/master">Updated</a>: ${NOW} (commit <a href="http://git.launchpad.net/~ubuntu-security/ubuntu-cve-tracker/commit/?id=${COMMIT}">${COMMIT}</a>)</p>
</div>
<div id="footer">
EOM
    echo "&copy; Canonical Ltd. 2007-`date +%Y`" >> "$outfile"
    cat >> "$outfile" <<EOM
</div>
</body>
</html>
EOM

}

OUTPUT=$($ubuntu_table_exe --html --supported --no-retired $table_args)
#for show in main universe partner index
for show in main universe partner
do
    outfile="${tmpdir}/${show}${suffix}.html"
    header "$outfile"
    introduction "$outfile" "$suffix"

    if [ "$show" = "main" ]; then
        echo "<h3 id='main'>Main</h3>" >> "$outfile"
        # all this sed work strips out the last column
        echo "$OUTPUT" | egrep '(<table>|</table>|<th>|SUPPORTED)' | egrep -v 'EMBARGOED' | sed -r 's#<td>[[:space:]]+<p>[[:space:]]*[a-zA-Z0-9\-]*[[:space:]]*</p>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#' >> "$outfile"
        echo "<p class='note'>* supported by Canonical Ltd</p>" >> "$outfile"
    elif [ "$show" = "universe" ]; then
        echo "<h3 id='universe'>Universe</h3>" >> "$outfile"
        echo "$OUTPUT" | egrep -v '(PARTNER|SUPPORTED|EMBARGOED)' | egrep -v 'EMBARGOED'| sed -r 's#<td>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#' >> "$outfile"
    elif [ "$show" = "partner" ]; then
        echo "<h3 id='partner'>Partner</h3>" >> "$outfile"
        echo "$OUTPUT" | egrep '(<table>|</table>|<th>|PARTNER)' | egrep -v 'EMBARGOED'| sed -r 's#<td>[[:space:]]+<p>[[:space:]]*[a-zA-Z0-9\-]*[[:space:]]*</p>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#' >> "$outfile"
    fi

    footer "$outfile"
done

err=
if [ -n "$support_db" ]; then
    if [ ! -f "$support_db" ]; then
        echo "Skipping flavors generation"
        err="yes"
    fi

    flavout="${tmpdir}/flavors.html"
    header "$flavout"
    echo "<ul>" >> "$flavout"

    for f in edubuntu kubuntu lubuntu mythbuntu ubuntu-budgie ubuntu-mate ubuntu-gnome ubuntustudio xubuntu ubuntukylin
    do
        outfile="${tmpdir}/${f}${suffix}.html"
        header "$outfile"
        echo '<p><a href="priority.html">Priority Color Key</a></p>' >> "$outfile"
        echo "<h3 id='$f'>CVEs affecting $f only</h3>" >> "$outfile"
        OUTPUT=$($ubuntu_table_exe --html --supported --no-retired $table_args --only-flavor --flavor="$f" --support-db="$support_db")
        echo "$OUTPUT" | egrep '(<table>|</table>|<th>|<tr)' | egrep -v 'EMBARGOED'| sed -r 's#<td>[[:space:]]+<p>[[:space:]]*[a-zA-Z0-9\-]*[[:space:]]*</p>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#' >> "$outfile"
        footer "$outfile"

        outfile="${tmpdir}/${f}${suffix}-all.html"
        header "$outfile"
        echo '<p><a href="priority.html">Priority Color Key</a></p>' >> "$outfile"
        echo "<h3 id='$f'>All CVEs affecting $f</h3>" >> "$outfile"
        OUTPUT=$($ubuntu_table_exe --html --supported --no-retired $table_args --flavor="$f" --support-db="$support_db")
        echo "$OUTPUT" | egrep '(<table>|</table>|<th>|<tr)' | egrep -v 'EMBARGOED'| sed -r 's#<td>[[:space:]]+<p>[[:space:]]*[a-zA-Z0-9\-]*[[:space:]]*</p>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#' >> "$outfile"

        footer "$outfile"

        echo "  <li>Open <a href='$f.html'>CVEs in $f</a> (<a href='$f-all.html'>all CVEs affecting $f</a>)</li>" >> "$flavout"
    done
    echo "</ul>" >> "$flavout"
    footer "$flavout"
fi

mv -f ${tmpdir}/* ${outdir}

if [ "$err" = "yes" ]; then
    exit 1
fi
