#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of supported packages for the devel release to prometheus
# for the KPIs
set -e

ARCHIVE=/srv/archive.ubuntu.com/ubuntu

RELEASES="trusty 14.04
xenial 16.04
bionic 18.04
cosmic 18.10"

echo "$RELEASES" | while read -r release version; do
  # Generate supported binary package counts data for each release
  COUNT=0
  for repo in main restricted; do
    COUNT=$((COUNT + $(zgrep ^Package: "$ARCHIVE/dists/$release/$repo/binary-i386/Packages.gz" | wc -l)))
  done
  if [ $COUNT -gt 0 ]; then
    echo "Pushing $release $version security_supported_package_count $COUNT to Prometheus"
    echo "security_supported_package_count{label=\"$release\"} $COUNT" | curl -s --data-binary @- "http://push.security.kpi.internal:9091/metrics/job/security_packages_job/instance/$version"
  else
    echo "ERROR: No supported packages found for release $release version $version"
  fi
  # Generate supported source package counts data for the devel release
  COUNT=0
  for repo in main restricted; do
    COUNT=$((COUNT + $(zgrep ^Package: "$ARCHIVE/dists/$release/$repo/source/Sources.gz" | wc -l)))
  done
  if [ $COUNT -gt 0 ]; then
    echo "Pushing $release $version security_supported_sourcepackages_count $COUNT to Prometheus"
    echo "security_supported_source_packages_count{label=\"$release\"} $COUNT" | curl -s --data-binary @- "http://push.security.kpi.internal:9091/metrics/job/security_sources_job/instance/$version"
  else
    echo "ERROR: No supported source packages found for release $release version $version"
  fi
done
