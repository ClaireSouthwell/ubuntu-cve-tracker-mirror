#!/usr/bin/python
# Author: Kees Cook <kees@ubuntu.com>
# Copyright (C) 2011 Canonical Ltd.
#
# Reports the version of the given package in the most recent USN for it
#
# Fetch the USN database first. Override location with --database
#  wget http://people.canonical.com/~ubuntu-security/usn/database.pickle
#
import sys, usn_lib, optparse
from source_map import version_compare
from lp_lib import UCTLaunchpad

parser = optparse.OptionParser()
parser.add_option("-D", "--database", help="Specify location of USN data (default 'database.pickle')", default="database.pickle")
parser.add_option("-r", "--release", help="Specify comma-separated list of which release to limit the search to (default is all)")
parser.add_option("-d", "--debug", dest="debug", help="Report additional debugging while processing", action='store_true')
(opt, args) = parser.parse_args()

uctlp = UCTLaunchpad(opt)

releases = None
if opt.release:
    releases = opt.release.split(',')

db   = usn_lib.load_database(opt.database)
pkgs = usn_lib.packages_dict(db, args, releases, opt=opt)
for pkg in args:
    if not pkgs.has_key(pkg):
        # Need to print the release pocket version of the package
        for rel in releases:
            print uctlp.get_earliest_version(rel, pkg)
    else:
        print sorted(pkgs[pkg], cmp=version_compare, reverse=True)[0]
