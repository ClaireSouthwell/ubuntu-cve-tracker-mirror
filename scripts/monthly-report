#!/bin/bash -e
# Copyright (C) 2008 Canonical, Ltd.
# Author: Kees Cook <kees@ubuntu.com>
# Author: Jamie Strandboge <jamie@ubuntu.com>
# License: GPLv3
#
# This script attempts to build up statistics for a monthly report on
# security update activity on USNs, triage, and outstanding tasks.
# It is designed to be run on the month _following_ the month one wants
# a report for.  e.g. run this script in April if you want the March report.

REP_MON=$(date +%B -d 'last month')
REP_MONN=$(date +%m -d 'last month')
REP_YEAR=$(date +%Y -d 'last month')

THIS_MONN=$(date +%m)
THIS_YEAR=$(date +%Y)

bzr diff >/dev/null || {
    echo "Aborting: uncommitted changes. Please use 'bzr commit' before proceeding"
    exit 1
}

USNS=$(echo $(curl -s https://lists.ubuntu.com/archives/ubuntu-security-announce/$REP_YEAR-$REP_MON/date.html | fgrep '">[USN-'  | cut -d- -f2,3 | cut -d\] -f1))

PUBLISHED=$(ssh jackass.canonical.com "PATH=/home/kees/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin /home/kees/bin/report-usn-numbers $USNS")

TMP1=$(mktemp -t work1-XXXXXX)
TMP2=$(mktemp -t work2-XXXXXX)
if [ ! -x "scripts/monthly-report" ]; then
    echo "Please run this from the top-level directory of Ubuntu CVE Tracker"
    exit 1
fi

bzr_rewind ()
{
    local changed count

    count=0
    changed="$1"
    while :; do
        bzr revert -r date:"$changed" >/dev/null 2>&1 && break
        changed=$(date +%Y-%m-%d -d "$changed - 1 day")
        count=$(( count + 1 ))
        if [ "$count" -gt 32 ]; then
            echo "Eeek, rewound from $1 past $changed.  Something is wrong."
            exit 1
        fi
    done
    #echo "rewound to $changed"
}


# Locate the last day something changed
bzr_rewind $(date +%Y-%m-%d -d "$REP_YEAR-$REP_MONN-01 - 1 day")
# Gather stats at the time
./scripts/check-cves --known > "$TMP1"

# Fast-forward to end of month
bzr revert >/dev/null 2>&1
bzr_rewind $(date +%Y-%m-%d -d "$THIS_YEAR-$THIS_MONN-01 - 1 day")
./scripts/check-cves --known > "$TMP2"
WORK=$(./scripts/report-todo-numbers -S)

# Calculate difference
TRIAGED=$(diff -u "$TMP1" "$TMP2" | grep '^+CVE' | wc -l)
rm -f "$TMP1" "$TMP2"

# Report!
echo "Subject: Monthly security report for $REP_MON $REP_YEAR"
echo ""
echo "$PUBLISHED."
echo "Triaged $TRIAGED CVEs."
echo ""
echo "$WORK"

# Get back to normal
bzr revert >/dev/null 2>&1

