#!/bin/sh

# Author: Jamie Strandboge <jamie@ubuntu.com>
# Author: Kees Cook <kees@ubuntu.com>
# Copyright (C) 2005-2008 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

set -e

print_key() {
	cat <<EOM
<table class="key">
<tr><th>Risk</th><th>Description</th></tr>
<tr class="critical">
 <td class="needed">Critical</td>
 <td class="desc">
  Open vulnerability that is a world-burning problem, exploitable for nearly
  all people in a default installation. Includes remote root privilege
  escalations, or massive data loss.
 </td>
</tr>
<tr class="high">
 <td class="needed">High</td>
 <td class="desc">
  Open vulnerability that is a real problem, exploitable for many people in a
  default installation. Includes serious remote denial of services, local root
  privilege escalations, or data loss.
 </td>
</tr>
<tr class="medium">
 <td class="needed">Medium</td>
 <td class="desc">
  Open vulnerability that is a real security problem, and is exploitable for
  many people.  Includes network daemon denial of service attacks, and gaining
  user privileges.
 </td>
</tr>
<tr class="low">
 <td class="needed">Low</td>
 <td class="desc">
  Open vulnerability that is a security problem, but is hard to exploit due to
  environment, requires a user-assisted attack, a small install base, or does
  very little damage.  These tend to be included in security updates only when
  higher priority issues require an update, or if many low priority issues have
  built up.
 </td>
</tr>
<tr class="negligible">
 <td class="needed">Negligible</td>
 <td class="desc">
  Open vulnerability that is technically a security problem, but is only
  theoretical in nature, requires a very special situation, has almost no install
  base, or does no real damage.  These tend not to get backport from upstreams,
  and will likely not be included in security updates unless there is an easy fix
  and some other issue causes an update.
 </td>
</tr>
<tr class="untriaged">
 <td class="needed">Unknown</td>
 <td class="desc">
  Open vulnerability where the priority is currently unknown and needs to be
  triaged.
 </td>
</tr>
<tr>
 <td class="pending">Pending</td>
 <td class="desc">
  A fix has been applied and updated packages are awaiting
  arrival into the archive. This often used when a package
  is received into -proposed for wider testing.
 </td>
</tr>
<tr>
 <td class="released">Not Vulnerable</td>
 <td class="desc">
  Packages which do not exist (DNE) in the archive, are not
  affected by the vulnerability or have a fix applied in the
  archive.
 </td>
</tr>
</table>
EOM
}

cat <<EOM
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Ubuntu CVE Tracker</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="author" content="Canonical Ltd, Kees Cook and Jamie Strandboge" />
<meta name="description" content="Ubuntu CVE Tracker" />
<meta name="copyright" content="Canonical Ltd" />

<style type='text/css' media='all'>
body {
 padding: 0 1em;
}

div#container {
 padding: 0;
}
div#footer {
 width: 100%;
 font-size: smaller;
 padding: 1em;
 text-align: center;
}
p#w3c {
 margin-top: 2em;
}

h2 {
 margin-top: 2em;
}

p.note {
 font-size: smaller;
 margin: 0.2em;
}

table.key, p.intro, p.key {
 width: 64%;
}
td.desc {
 text-align: left;
}

table {
 border-collapse: collapse;
 border: 2px solid black;
}
th {
 border-bottom: 2px solid black;
}

/* basic styling */
td {
 border: 1px solid black;
 text-align: center;
 padding-left: 0.5em;
 padding-right: 0.5em;
 background-color: white;
 font-size: smaller;
}

/* critical and high */
tr.critical td.needed, tr.critical td.needs-triage, tr.critical td.pkgpending, tr.high td.needed, tr.high td.needs-triage, tr.high td.pkgpending {
 background-color: red;
}

/* medium */
tr.medium td.needed, tr.medium td.needs-triage, tr.medium td.pkgpending {
 background-color: orange;
}

/* low */
tr.low td.needed, tr.low td.needs-triage, tr.low td.pkgpending {
 background-color: yellow;
}

/* negligible */
tr.negligible td.needed, tr.negligible td.needs-triage, tr.negligible td.pkgpending {
 background-color: #ddd;
}

/* released, DNE, not-affected */
td.released, td.DNE, td.not-affected {
 background-color: green;
}

/* untriaged */
tr.untriaged td.needed, tr.untriaged td.needs-triage, tr.untriaged td.pkgpending {
 background-color: #f6f;
}

/* pending */
td.pending {
 background-color: #0f0;
}

td p {
 padding: 0;
 margin: 0;
}

</style>
</head>

<body>
<div id="container">
<h1>Ubuntu CVE Tracker</h1>
<h3>Introduction</h3>
<p class="intro">Ubuntu tracks its security vulnerabilities via the <a
href="https://launchpad.net/ubuntu-cve-tracker">Ubuntu CVE Tracker</a>. 
This report is divided into the following sections:</p>
<ul>
  <li><a href="#main">Main</a> (supported by Canonical Ltd)</li>
  <li><a href="#universe">Universe</a> (supported by the Ubuntu community)</li>
  <li><a href="#partner">Partner</a> (supported by upstream vendor)</li>
</ul>

<p class="key">Vulnerabilities are color coded using the following
key:</p>
EOM
print_key
echo "<h2 id='main'>Main</h2>"
OUTPUT=$(./scripts/ubuntu-table --html --supported --no-retired "$@")

# all this sed work strips out the last column
echo "$OUTPUT" | egrep '(<table>|</table>|<th>|SUPPORTED)' | egrep -v 'EMBARGOED' | sed -r 's#<td>[[:space:]]+<p>[[:space:]]*[a-zA-Z0-9\-]*[[:space:]]*</p>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#'
echo "<p class='note'>* supported by Canonical Ltd</p>"

echo "<h2 id='universe'>Universe</h2>"
echo "$OUTPUT" | egrep -v '(PARTNER|SUPPORTED|EMBARGOED)' | egrep -v 'EMBARGOED'| sed -r 's#<td>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#'

echo "<h2 id='partner'>Partner</h2>"
echo "$OUTPUT" | egrep '(<table>|</table>|<th>|PARTNER)' | egrep -v 'EMBARGOED'| sed -r 's#<td>[[:space:]]+<p>[[:space:]]*[a-zA-Z0-9\-]*[[:space:]]*</p>[[:space:]]+</td>[[:space:]]+</tr>$#</tr>#' | sed -r 's#<th>Notes</th></tr>$#</tr>#'

echo "<p class='note'>* supported by Canonical Ltd</p>"

NOW=$(date -u +"%Y-%m-%d %R %Z")
COMMIT=$(bzr log --limit=1 --line | cut -d: -f1)
cat <<EOM
<p id="w3c">
  <a href="http://validator.w3.org/check?uri=referer"><img
    src="http://www.w3.org/Icons/valid-xhtml10"
    alt="Valid XHTML 1.0 Strict" height="31" width="88" style="border: 0;"/></a>
</p>
<p class='note'>Updated: ${NOW} (commit ${COMMIT})</p>
</div>
<div id="footer">
EOM
echo "&copy; Canonical Ltd 2007-`date +%Y`"
cat <<EOM
</div>
</body>
</html>
EOM

