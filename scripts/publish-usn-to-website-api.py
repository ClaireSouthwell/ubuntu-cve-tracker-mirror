#! /usr/bin/env python3
# imported from https://github.com/canonical-web-and-design/ubuntu.com/blob/master/webapp/security/fixtures/usns.py

# Standard library
import argparse
import json
import sys

# Packages
from macaroonbakery import httpbakery


parser = argparse.ArgumentParser(description="CLI to post USNs",)
parser.add_argument(
    "--json", action="store", type=str,
    )
parser.add_argument(
    "--action", action="store", type=str,
    default="add",
    choices=['add', 'update', 'remove']
    )
parser.add_argument(
    "--endpoint", action="store", type=str,
    #default="https://ubuntu.com/security/notices"
    default="https://staging.ubuntu.com/security/notices"
    #default="http://localhost:8001/security/notices"
    )

args = parser.parse_args()

client = httpbakery.Client()

if args.action == 'add':
    http_method = 'POST'
elif args.action == 'update':
    http_method = 'PUT'
elif args.action == 'remove':
    sys.exit(f"Error: {args.action} action not implemented yet")
else:
    sys.exit(f"Error: {args.action} action not implemented yet")


# Make a first call to make sure we are logged in
response = client.request(http_method, url=args.endpoint)


with open(args.json) as usn_json:
    payload = json.load(usn_json).items()
    for notice_id, notice in payload:
        response = client.request(
            http_method, url=args.endpoint, json=notice
        )
        print(response, response.text)
