#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Extracts the number of subscribers from a lists.ubuntu.com mailman list
# Expects list name and password as parameters
set -e

list=$1
password=$2

if [ -z "$list" ]; then
  echo "Please provide list name as first parameter."
  exit 1
fi

if [ -z "$password" ]; then
  echo "Please provide list admin password as second parameter."
  exit 1
fi

cookie="./$list.cookie"
rm -f "$cookie"
curl -s -L -X POST -j -b "$cookie" -c "$cookie" --data 'adminpw='"$password"'&admlogin=Let me in...' "https://lists.ubuntu.com/mailman/admin/$list" > /dev/null
key=$(grep lists "$list".cookie | cut -f 6)
val=$(grep lists "$list".cookie | cut -f 7)
curl -s -L -X GET -b "$key"="$val" -c "$cookie" "https://lists.ubuntu.com/mailman/admin/$list/members" | grep "members total" | sed s/'.*>\([0-9]\+\) members total.*/\1/'
curl -s -L -X GET -b "$key"="$val" -c "$cookie" "https://lists.ubuntu.com/mailman/admin/$list/logout" > /dev/null
rm -f "$cookie"
