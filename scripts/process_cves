#!/bin/sh
# Copyright 2009-2013 Canonical, Ltd.
# Authors:
#  Jamie Strandboge <jamie@canonical.com>
#  Kees Cook <kees@ubuntu.com>
#  Marc Deslauriers <marc.deslauriers@canonical.com>
#
# Script to help triage CVEs based on Triage Frequency in $UCT/README
#

set -e

loc=$(readlink -f $(dirname $0)/..)

uctconf="$HOME/.ubuntu-cve-tracker.conf"
if [ -s "$uctconf" ]; then
    . "$uctconf"
else
    echo "Could not find '$uctconf'" >&2
    exit 1
fi

download() {
    url="$1"
    # if http, then download it with wget, otherwise, try to rsync it
    if echo "$url" | grep -q "^http" ; then
        echo "wget -N \"$url\""
        wget -N "$url" ||:
    else
        echo "rsync -vz --progress \"$url\" ."
        rsync -vz --progress "$url" .
    fi
    echo "---"
}

update_debian() {
    # Update Debian SVN
    if [ -n "$secure_testing_path" ] && [ -d "${secure_testing_path}/.svn" ] ; then
        echo "Updating '$secure_testing_path'"
        cd "$secure_testing_path"
        svn update || echo "Error updating Debian tree"
        cd "$loc"
    fi
}

update_files() {
    download "${mitre_loc:-http://cve.mitre.org/data/downloads}/allitems.xml"
    download "${nvd_loc:-http://nvd.nist.gov/download}/nvdcve-2*.xml"
    download "http://nvd.nist.gov/download/nvdcve-recent.xml.gz"
    gunzip -f ./nvdcve-recent.xml.gz
}

full_refresh() {
    # get PubDate
    echo "update PubDate (check-cves --refresh nvdcve-*.xml) ..."
    ./scripts/check-cves --refresh nvdcve-*.xml

    # get authoritative descriptions
    echo "get authoritative descriptions (check-cves --refresh ./allitems.xml) ..."
    ./scripts/check-cves --refresh ./allitems.xml
}

kernel_team_merge() {
    echo "Merging with kernel team CVE tracker"
    kernelteam='lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team'

    if ! bzr missing --theirs-only $kernelteam ; then
        # Find their most recent merge point
        lastmerge=$(bzr missing --mine-only $kernelteam | grep revno | cut -d' ' -f2 | tail -n1)
        if [ -n "$lastmerge" ]; then
            lastmerge=$(( $lastmerge - 1 ))
        else
            lastmerge=$(bzr log | head -n10 | grep revno | head -n1 | cut -d' ' -f2)
        fi
        # Pull their changes
        if ! bzr merge $kernelteam ; then
            echo "Merge failed! Please fix, and then 'exit 0' to continue..."
            bash
        fi
        # Extract a diff of what they changed, relative to the merge point
        diff=$(mktemp -t kernel-team-diff-XXXXXX)
        bzr diff -r$lastmerge --new=$kernelteam >> $diff || true
        if [ -s $diff ]; then
            # Look it over
            ${EDITOR:-vi} $diff
        fi
        rm -f $diff
    fi
}

process_missing_debian() {
    echo "check-cves --import-missing-debian"
    ./scripts/check-cves --import-missing-debian
}

download_missing_redhat() {
    tmpdir="$1"
    archive="$2.txt"
    fn="$tmpdir/$archive"
    url="https://www.redhat.com/archives/rhsa-announce/$archive.gz"

    echo "Downloading $url..."
    # curl and wget fail with redhat's web proxy
    w3m -dump_source "$url" > "$fn.gz"
    echo "Unzipping $fn.gz..."
    gzip -d "$fn.gz" || {
        # This can happen at the start of a new month and RedHat has provided
        # any advisories yet
        echo "(skipping '$fn.gz')"
        rm -f "$fn.gz"
        return
    }

    echo "locate_cves.py $fn..."
    ./scripts/locate_cves.py "$fn" >> "$tmpdir/redhat.mbox"
}

process_missing_redhat() {
    tmpdir=`mktemp -d`
    download_missing_redhat $tmpdir `date +%Y-%B`
    download_missing_redhat $tmpdir `date --date="$(date +%Y-%m-15) -1 month" +%Y-%B`
    ./scripts/check-cves --untriaged "$tmpdir/redhat.mbox"
    rm -rf "$tmpdir"
}

nag_about_mailing_lists() {
    cat <<EOM

*** IMPORTANT ***
Mitre and NVD are no longer updated in a timely fashion. Please review
oss-security, linux-distros, nd vendor mailing lists for any new CVEs after
doing triage. This script pulls in RHSAs on Wednesdays and DSAs daily.

Eg, to triage oss-security (assumes in the UCT directory):
 <save last month to mbox file, ~/oss-sec.mbox>
 $ ./scripts/check-cves --mbox ~/oss-sec.mbox
EOM
}

prev_dir=`pwd`
trap "cd '$prev_dir'" EXIT HUP INT QUIT TERM

# Determine mode
action=`LC_TIME=C date +%a`
if [ ! -z "$1" ]; then
    action="$1"
fi

case "$action" in
    Mon)
        update_debian
        update_files

        kernel_team_merge
        echo "check-cves nvdcve-*.xml"
        ./scripts/check-cves nvdcve-*.xml
        process_missing_debian

        nag_about_mailing_lists
        ;;
    Wed)
        update_debian
        update_files
        kernel_team_merge

        # process new ones
        echo "check-cves ./nvdcve-recent.xml"
        ./scripts/check-cves ./nvdcve-recent.xml
        echo "check-cves ./allitems.xml"
        ./scripts/check-cves ./allitems.xml

        process_missing_debian
        process_missing_redhat

        full_refresh
        nag_about_mailing_lists
        ;;
    redhat)
        process_missing_redhat
        ;;
    debian)
        update_debian
        process_missing_debian
        ;;
    update)
        # Do no triage
        update_debian
        update_files
        ;;
    refresh)
        # Do no triage
        update_debian
        update_files
        full_refresh
        ;;
    merge)
        # Do no triage
        update_debian
        update_files
        kernel_team_merge
        ;;
    *)
        update_debian
        update_files
        kernel_team_merge
        echo "check-cves ./nvdcve-recent.xml"
        ./scripts/check-cves ./nvdcve-recent.xml
        process_missing_debian
        nag_about_mailing_lists
        ;;
esac

exit 0
