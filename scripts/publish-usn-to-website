#!/bin/bash
#
# This will generate markdown for the specified USN and update the USN website
# git tree so that a new instance of the website is automatically deployed with
# the new USN content.
#
# Copyright 2018, Canonical, Ltd.
# Author: Tyler Hicks <tyhicks@canonical.com>
# License: GPLv3
set -e
export LANG=C

. "$HOME"/.ubuntu-cve-tracker.conf
template="$usn_tool"/templates/webpage-markdown.txt
database="$usn_db_copy"

# $0: program name
usage() {
	echo "Usage: $0 [options] <USN>"
	echo "Update the USN website git tree with markdown for the specified <USN>."
	echo "Specify <USN> with only the number portion of the ID, such as 2165-1."
	echo ""
	echo "Valid options:"
	echo "  -d [DATABASE]   Use DATABASE as the USN db to consult for information on <USN>"
	echo "  -h              Print usage information"
}

while getopts "d:h" opt ; do
	case "$opt" in
		d) database="$OPTARG";;
		h) usage; exit 0;;
		?) usage 1>&2; exit 1;;
	esac
done
shift $((OPTIND - 1))

usn="$1"
branch=usn-"$usn"
markdown="$usn_website"/content/"$usn".md
update_existing=false

if ! "$usn_tool"/usn.py --db "$database" --show "$usn" > /dev/null; then
	echo "ERROR: Ensure that USN-$usn is in $database and try again" 1>&2
	exit 1
fi

cd "$usn_website"
git fetch -q origin
if [ -n "$(git status --porcelain)" ]; then
	echo "ERROR: USN website git tree ($usn_website) is unclean:" 1>&2
	git status -s 1>&2
	exit 1
fi

if [ -f "$markdown" ]; then
	echo "WARNING: Updating existing markdown for USN-$usn"
	update_existing=true
fi

# https://git-blame.blogspot.com/2013/06/checking-current-branch-programatically.html
if ! orig_branch=$(git symbolic-ref --short -q HEAD); then
	echo "ERROR: Unable to return to current checkout of USN website git tree ($usn_website)" 1>&2
	echo "Save any work, checkout a regular branch such as master, and try again" 1>&2
	exit 1
fi

git checkout -qb "$branch" origin/master
"$usn_tool"/usn.py --db "$database" --template "$template" "$usn" > "$markdown"
if [ "$update_existing" = false ]; then
	git add -N "$markdown"
	git commit -qsm "Add USN-$usn" "$markdown"
else
	git commit -qsm "Update USN-$usn" "$markdown"
fi
git checkout -q "$orig_branch"
git push -q origin "$branch":master
git fetch -q origin
git branch -qD "$branch"

echo "Success! Please monitor the website deployment status here:"
echo
echo "  https://jenkins.canonical.com/webteam/job/deploy-to-usn.ubuntu.com/"
