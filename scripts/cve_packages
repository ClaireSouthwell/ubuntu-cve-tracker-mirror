#!/usr/bin/perl -w
#
# cve_packages [-t] [-S]
#

use strict;
use vars qw($opt_t $opt_S);
use Getopt::Std;

my %negligible;
my %low;
my %medium;
my %high;
my %critical;
my %untriaged;
my %packages;
my %supported;

my %points = ( 'negligible' => 0,
		'untriaged' => 5,
		'low' => 10,
		'medium' => 50,
		'high' => 100,
		'critical' => 200,
);

getopts('St');

my $totals_only;
if ($opt_t) {
	$totals_only = "yes";
}

my $skipdevel = "";
if ($opt_S) {
	$skipdevel = "-S";
}

open CVES, "./scripts/ubuntu-table --supported $skipdevel |" or die;

while (<CVES>) {
	my @parts = split();

	my $pkgname = $parts[1];
	$pkgname =~ s/://g;
	my $priority = $parts[$#parts];	

	(not defined($packages{$pkgname}) and $packages{$pkgname} = 1) or $packages{$pkgname}++;

	if ($priority =~ /^untriaged$/) {
		(not defined($untriaged{$pkgname}) and $untriaged{$pkgname} = 1) or $untriaged{$pkgname}++;
	}
	if ($priority =~ /^negligible$/) {
		(not defined($negligible{$pkgname}) and $negligible{$pkgname} = 1) or $negligible{$pkgname}++;
	}
	if ($priority =~ /^low$/) {
		(not defined($low{$pkgname}) and $low{$pkgname} = 1) or $low{$pkgname}++;
	}
	if ($priority =~ /^medium$/) {
		(not defined($medium{$pkgname}) and $medium{$pkgname} = 1) or $medium{$pkgname}++;
	}
	if ($priority =~ /^high$/) {
		(not defined($high{$pkgname}) and $high{$pkgname} = 1) or $high{$pkgname}++;
	}
	if ($priority =~ /^critical$/) {
		(not defined($critical{$pkgname}) and $critical{$pkgname} = 1) or $critical{$pkgname}++;
	}

	if (not defined($supported{$pkgname}) and /SUPPORTED/) {
		$supported{$pkgname} = "SUPPORTED";
	} elsif (not defined($supported{$pkgname}) and /PARTNER/) {
		$supported{$pkgname} = "PARTNER";
	}
}

print "Weight\tPackage Counts\n";
print "---------------------------------------------------------------------\n";
foreach my $k (sort keys(%packages)) {
	if (defined($ARGV[0])) {
		my $display = 0;
		foreach my $arg (@ARGV) {
			$display = 1 if ($arg eq $k);
		}
		next if (!$display);
	}

	my $score = 0;

	defined ($untriaged{$k}) and $score += $untriaged{$k} * $points{'untriaged'};
	defined ($negligible{$k}) and $score += $negligible{$k} * $points{'negligible'};
	defined ($low{$k}) and $score += $low{$k} * $points{'low'};
	defined ($medium{$k}) and $score += $medium{$k} * $points{'medium'};
	defined ($high{$k}) and $score += $high{$k} * $points{'high'};
	defined ($critical{$k}) and $score += $critical{$k} * $points{'critical'};

	if ($totals_only) {
		print "$k: $packages{$k}";
	} else {
		print "$score\t$k: $packages{$k} total";
		defined ($untriaged{$k}) and print ", $untriaged{$k} untriaged";
		defined ($negligible{$k}) and print ", $negligible{$k} negligible";
		defined ($low{$k}) and print ", $low{$k} low";
		defined ($medium{$k}) and print ", $medium{$k} medium";
		defined ($high{$k}) and print ", $high{$k} high";
		defined ($critical{$k}) and print ", $critical{$k} critical";
	}
	defined($supported{$k}) and print " ($supported{$k})";
	print "\n";
}


close (CVES);

