#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of supported packages for the devel release to prometheus
# for the KPIs
set -e

ARCHIVE=/srv/archive.ubuntu.com/ubuntu

REL=cosmic  # set to last column in templates (ie, the devel release)
RELTAG="18.10"  # set to version of $REL, e.g. 18.10

# Generate supported binary package counts data for the devel release
COUNT=0
for repo in main restricted; do
  COUNT=$((COUNT + $(zgrep ^Package: $ARCHIVE/dists/$REL/$repo/binary-i386/Packages.gz | wc -l)))
done
echo "Pushing $REL $RELTAG security_supported_package_count $COUNT to Prometheus"
echo "security_supported_package_count{label=\"$REL\"} $COUNT" | curl -s --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_packages_job/instance/$RELTAG

# Generate supported source package counts data for the devel release
COUNT=0
for repo in main restricted; do
  COUNT=$((COUNT + $(zgrep ^Package: $ARCHIVE/dists/$REL/$repo/source/Sources.gz | wc -l)))
done
echo "Pushing $REL $RELTAG security_supported_sourcepackages_count $COUNT to Prometheus"
echo "security_supported_source_packages_count{label=\"$REL\"} $COUNT" | curl -s --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_sources_job/instance/$RELTAG
