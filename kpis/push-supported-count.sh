#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of supported packages for the supported releases to
# prometheus for the KPIs
set -e

# shellcheck source=common.sh
. "$(dirname "${BASH_SOURCE[0]}")/common.sh"

ARCHIVE=${packages_mirror:-/srv/archive.ubuntu.com/ubuntu}

echo "$RELEASES_VERSIONS" | while read -r release version; do
  # Generate supported binary package counts data for each release
  COUNT=0
  for repo in main restricted; do
    COUNT=$((COUNT + $(zgrep ^Package: "$ARCHIVE/dists/$release/$repo/binary-i386/Packages.gz" | wc -l)))
  done
  if [ $COUNT -gt 0 ]; then
    DATA="security_supported_package_count{label=\"$release\"} $COUNT"
    JOB="security_packages_job/instance/$version"
    push_to_prometheus "$DATA" "$JOB"
  else
    error "No supported packages found for release $release version $version"
  fi
  # Generate supported source package counts data for the devel release
  COUNT=0
  for repo in main restricted; do
    COUNT=$((COUNT + $(zgrep ^Package: "$ARCHIVE/dists/$release/$repo/source/Sources.gz" | wc -l)))
  done
  if [ $COUNT -gt 0 ]; then
    DATA="security_supported_source_packages_count{label=\"$release\"} $COUNT"
    JOB="security_sources_job/instance/$version"
    push_to_prometheus "$DATA" "$JOB"
  else
    error "No supported source packages found for release $release version $version"
  fi
done
