#!/bin/bash
# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Push mailing list subscribers to prometheus for KPIs (requires passwords to
# be in ~/.ubuntu-cve-tracker.conf as per README)
set -e

. "$HOME"/.ubuntu-cve-tracker.conf

# push mailing list subscribers
echo "Querying number of subscribers for ubuntu-hardened list..."
COUNT=$(./get-total-mailman-subscribers.sh ubuntu-hardened $ubuntu_hardened_admin_password)
echo "Pushing $COUNT ubuntu-hardened subscribers to Prometheus"
echo "security_ubuntu_hardened_subscriber_count " | curl --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_subscribers_job/instance/ubuntu_hardened

echo "Querying number of subscribers for ubuntu-security-announce list..."
COUNT=$(./get-total-mailman-subscribers.sh ubuntu-security-announce $ubuntu_security_announce_admin_password)
echo "Pushing $COUNT ubuntu-security-announce subscribers to Prometheus"
echo "security_ubuntu_security_announce_subscriber_count " | curl --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_subscribers_job/instance/ubuntu_security_announce
