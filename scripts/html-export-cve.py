#!/usr/bin/python

# Author: Kees Cook <kees@ubuntu.com>
# Copyright (C) 2005-2008 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# AKA "Kees writes the worst HTML in the world"
import sys
import cve_lib
from urllib import quote
from cgi import escape

# FIXME: detect and safely quote URLs

cvefile = sys.argv[1]
ret, data = cve_lib.load_cve(cvefile)
if ret != cve_lib.EXIT_OKAY:
    raise ValueError, "Could not load %s" % (cvefile)

#import pprint
#pp = pprint.PrettyPrinter(indent=4)
#pp.pprint(data)

cve = data['Candidate']

print '''<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>%s in Ubuntu</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="author" content="Canonical Ltd, and others" />
<meta name="description" content="Ubuntu CVE Entry" />
<meta name="copyright" content="Canonical Ltd, and others" />
</head>

<body>
''' % (escape(cve))

# CVE cross links
print '<div class="cve"><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=%s">%s</a> <a href="https://launchpad.net/bugs/cve/%s">Launchpad</a> <a href="http://security-tracker.debian.net/tracker/%s">Debian</a></div>' % (quote(cve),escape(cve),quote(cve),quote(cve))

# Handle "free-form" text
for field in ['Priority','References','Bugs','Description','Ubuntu-Description','Notes','Assigned-to']:
    if not data.has_key(field):
        continue
    text = data[field].strip()
    if len(text) == 0:
        continue

    escaped_body = ""
    for line in text.split('\n'):
        escaped_body += '%s<br />' % (escape(line))

    print '<div class="item"><div class="field">%s:</div> <div class="value">%s</div></div>' % (escape(field),escaped_body)

# Handle package logic
for pkg in data['pkgs']:
    print '<div class="pkg">'
    print '<ul><a href="https://launchpad.net/distros/ubuntu/+source/%s">%s</a>' % (quote(pkg),escape(pkg))

    # move upstream to the front of the list...
    releases = [] + cve_lib.releases
    releases.insert(0,releases.pop())
    for release in releases:
        if not data['pkgs'][pkg].has_key(release):
            continue

        relname = release
        if relname == 'devel':
            relname = cve_lib.devel_release

        status = data['pkgs'][pkg][release][0]
        notes  = data['pkgs'][pkg][release][1]

        name = '%s' % (escape(release))
        if status != 'DNE' and relname != 'upstream':
            name = '<a href="https://launchpad.net/ubuntu/%s/+source/%s">%s</a>' % (quote(relname),quote(pkg),escape(relname))

        print '<li>%s: %s' % (name, status)
        if len(notes):
            print '(%s)' % (escape(notes))
        print '</li>'

    patches = 'Patches_%s' % (pkg)
    if data.has_key(patches):
        entries = data[patches]
        for patch in entries.split('\n'):
            if not ':' in patch:
                continue
            source, url = patch.split(':',1)
            print '<li><b>%s patch:</b>: %s</li>' % (escape(source),escape(url))
    print '</ul>'

print '''</body>
</html>
'''    
