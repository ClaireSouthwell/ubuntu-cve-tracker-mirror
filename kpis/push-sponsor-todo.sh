#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of debdiffs awaiting sponsorship to prometheus for the KPIs
set -e

# move into the directory which contains this script
pushd $(dirname "${BASH_SOURCE[0]}")

pushd ..
COUNT=$(./scripts/report-todo-sponsoring | tail -1 | cut -f1 -d" ")
popd
popd

if [ "$COUNT" ]; then
  echo "Pushing $COUNT packages requiring sponsoring to Prometheus..."
  at <<EOF | curl --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_job/instance/security_instance
  # TYPE security_sponsoring_available_daily counter
  security_debdiffs_available_to_sponsor $COUNT
EOF
  exit 0
else
  echo "Failed to get number of packages requiring sponsoring."
  exit 1
fi
