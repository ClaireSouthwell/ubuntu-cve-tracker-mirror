#!/usr/bin/python
# Copyright 2011, Canonical, Ltd
# Author: Kees Cook <kees@ubuntu.com>
# License: GPLv3
# generate raw data of CVE additions.
#
import subprocess

# This is insanely slow because 'bzr log -v' is slow. See the man page :(
# Example "bzr log" output...
#revno: 4110
#committer: Marc Deslauriers <marc.deslauriers@canonical.com>
#branch nick: master
#timestamp: Thu 2011-09-15 14:31:17 -0400
#message:
#  - added kernel CVE descriptions
#  - researched ffmpeg cves
#  - added new ffmpeg cve
#added:
#  active/CVE-...
adding = False
date = None
count = dict()
for line in subprocess.Popen(['bzr','log','-v','--include-merges'],
                             stdout=subprocess.PIPE).stdout:
    #if line.startswith('revno: '):
    #    print line.strip()
    if line.startswith('timestamp: '):
        # snag the year/month
        date = line.split(' ')[2].replace('-','')[:6]
        count.setdefault(date, 0)
    elif line.startswith('added:'):
        adding = True
    elif not line.startswith(' '):
        adding = False
    if adding:
        name = line.strip()
        if name.startswith('active/CVE-'):
            #print date, name
            count[date] += 1

for date in sorted(count):
    print date, count[date]
