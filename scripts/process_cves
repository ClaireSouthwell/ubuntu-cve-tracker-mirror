#!/bin/sh
# Copyright 2009-2011 Canonical, Ltd.
# Authors:
#  Jamie Strandboge <jamie@canonical.com>
#  Kees Cook <kees@ubuntu.com>
#
# Script to help triage CVEs based on Triage Frequency in $UCT/README
#

set -e

uctconf="$HOME/.ubuntu-cve-tracker.conf"
if [ -s "$uctconf" ]; then
    . "$uctconf"
else
    echo "Could not find '$uctconf'" >&2
    exit 1
fi

download() {
    url="$1"
    # if http, then download it with wget, otherwise, try to rsync it
    if echo "$url" | grep -q "^http" ; then
        echo "wget -N \"$url\""
        wget -N "$url"
    else
        echo "rsync -vz --progress \"$url\" ."
        rsync -vz --progress "$url" .
    fi
    echo "---"
}

update_files() {
    download "$mitre_loc/allitems.xml"
    download "$nvd_loc/nvdcve-2*.xml"
    download "http://nvd.nist.gov/download/nvdcve-recent.xml"
}

full_refresh() {
    # get PubDate
    echo "update PubDate (check-cves --refresh nvdcve-*.xml) ..."
    ./scripts/check-cves --refresh nvdcve-*.xml

    # get authoritative descriptions
    echo "get authoritative descriptions (check-cves --refresh ./allitems.xml) ..."
    ./scripts/check-cves --refresh ./allitems.xml
}

kernel_team_merge() {
    echo "Merging with kernel team CVE tracker"
    kernelteam='lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team'

    if ! bzr missing --theirs-only $kernelteam ; then
        # Find their most recent merge point
        lastmerge=$(bzr missing --mine-only $kernelteam | grep revno | cut -d' ' -f2 | tail -n1)
        if [ -n "$lastmerge" ]; then
            lastmerge=$(( $lastmerge - 1 ))
        else
            lastmerge=$(bzr log | head -n10 | grep revno | head -n1 | cut -d' ' -f2)
        fi
        # Pull their changes
        bzr merge $kernelteam
        # Extract a diff of what they changed, relative to the merge point
        diff=$(mktemp -t kernel-team-diff-XXXXXX)
        bzr diff -r$lastmerge --new=$kernelteam >> $diff
        if [ -s $diff ]; then
            # Look it over
            ${EDITOR:-vi} $diff
        fi
        rm -f $diff
    fi
}

prev_dir=`pwd`
trap "cd '$prev_dir'" EXIT HUP INT QUIT TERM

# Update Debian SVN
if [ -n "$secure_testing_path" ] && [ -d "${secure_testing_path}/.svn" ] ; then
    echo "Updating '$secure_testing_path'"
    cd "$secure_testing_path"
    svn update
fi

cd ${UCT}

# Determine mode
action=`LC_TIME=C date +%a`
if [ ! -z "$1" ]; then
    action="$1"
fi

update_files

case "$action" in
    Mon)
        kernel_team_merge
        echo "check-cves nvdcve-*.xml"
        ./scripts/check-cves nvdcve-*.xml
        ;;
    Wed)
        kernel_team_merge
        full_refresh

        # process new ones
        echo "check-cves ./nvdcve-recent.xml"
        ./scripts/check-cves ./nvdcve-recent.xml
        echo "check-cves ./allitems.xml"
        ./scripts/check-cves ./allitems.xml

        full_refresh
        ;;
    update)
        # Do no triage
        ;;
    refresh)
        # Do no triage
        full_refresh
        ;;
    merge)
        # Do no triage
        kernel_team_merge
        ;;
    *)
        kernel_team_merge
        echo "check-cves ./nvdcve-recent.xml"
        ./scripts/check-cves ./nvdcve-recent.xml
        ;;
esac

exit 0
