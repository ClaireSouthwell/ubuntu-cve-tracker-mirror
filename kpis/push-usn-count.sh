#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of USNs published per month to prometheus for the KPIs

# Hacking the date format because the graph gets to be unreadable in Grafana.
# This way the year just gets published once which slightly improves readability
# when looks like 2017-12
# instance looks like 12 unless it is January then it is 2018-01
while read when count; do
  year=`echo $when | cut -f1 -d"-"`
  month=`echo $when | cut -f2 -d"-"`
  instance=$month
  if [[ $month == "01" ]]; then
    instance=$when
  fi
  echo "security_usn_publications_monthly{label=\"$instance\"} $count" | curl --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_usn_job/instance/$when
done <USN.data
