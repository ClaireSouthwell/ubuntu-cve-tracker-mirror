import os
import re

RELEASE = "trusty"
UCT="/home/msalvatore/git/ubuntu-cve-tracker"
SUBPROJECT = "%s/experimental/subprojects/private-esm" % UCT
ACTIVE = "%s/active" % UCT
RETIRED = "%s/retired" % UCT

cve_file_regex = re.compile(r'CVE-\d+-\d+')
uct_entry_regex = re.compile(r"%s/esm_(.+?):.+" % RELEASE)


def map_cves_to_files(cve_files, cve_dir):
    for cve in os.listdir(cve_dir):
        if cve_file_regex.match(cve):
            if cve in cve_files:
                raise Exception("Found duplicate CVE file %s/%s" % (cve_dir, cve))
            cve_files[cve] = "%s/%s" % (cve_dir, cve)

    return cve_files

def get_esm_status(cve, package_name):
    escaped_package_name = re.escape(package_name)
    package_line_regex = re.compile(r"%s/esm_%s: .+" % (RELEASE, escaped_package_name))

    with open("%s/%s" % (SUBPROJECT, cve)) as esm_file:
        for line in esm_file:
            if package_line_regex.match(line):
                return line.replace("released-esm", "released")

    return None


cve_files = {}
map_cves_to_files(cve_files, ACTIVE)
map_cves_to_files(cve_files, RETIRED)

private_esm_files = [f for f in os.listdir(SUBPROJECT) if cve_file_regex.match(f)]

for cve in private_esm_files:
    new_contents = ""
    with open(cve_files[cve], "r") as f:
        for line in f:
            match = uct_entry_regex.match(line)
            if match:
                package_name = match.group(1)
                new_line = get_esm_status(cve, package_name)
                line = line if new_line is None else new_line
            
            new_contents += line

    with open(cve_files[cve], "w") as f:
        f.write(new_contents)
