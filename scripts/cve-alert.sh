#!/bin/sh
# Copyright 2011-2012 Canonical, Ltd
# Author: Jamie Strandboge <jamie@canonical.com>
# License: GPLv3
set -e

#
# Configuration
#
alert_threshold=10
alert_high_threshold=0
alert_ignore="linux|webkit|qt4-x11|qtwebkit-source|firefox|thunderbird|xulrunner|PARTNER"

#
# Helpers
#
check_output() {
    search=$1
    thresh=$2
    cve_packages_args="-m -a --deferred-days=30"

    out=""
    if [ "$search" = "high|critical" ]; then
        # Never ignore anything high or critical in our list, even if only
        # in our devel release
        out=`./scripts/cve_packages $cve_packages_args | grep '^[0-9]' | egrep "$search" | sort -n`
        if [ -z "$out" ]; then
            return
        fi
    elif [ "$search" = "medium or >5 low" ]; then
	# Show packages with a medium or higher as well as those with 5 or more
        # lows.
        out=`./scripts/cve_packages $skip_devel $cve_packages_args | egrep -v "($alert_ignore)" | grep '^[0-9]' | egrep "(([1-9]{1,}[0-9]| [5-9]) low | medium)" | sort -n`
        if [ -z "$out" ]; then
            echo "ERROR: No cve_packages output!" >&2
            exit 1
        fi
    elif [ "$search" = "heuristics" ]; then
        out=`./scripts/cve_packages $skip_devel $cve_packages_args | egrep -v "($alert_ignore)" | egrep '^([5-9][0-9]|[1-9]{1,}[0-9]{2,})[[:space:]]' | sort -n`
        if [ -z "$out" ]; then
            echo "ERROR: No cve_packages output!" >&2
            exit 1
        fi
    else
        out=`./scripts/cve_packages $skip_devel $cve_packages_args | egrep -v "($alert_ignore)" | grep '^[0-9]' | egrep "$search" | sort -n`
        if [ -z "$out" ]; then
            echo "ERROR: No cve_packages output!" >&2
            exit 1
        fi
    fi

    total=$(echo "${out}" | wc -l)
    if [ ${total} -gt ${thresh} ]; then
        echo "WARNING: too many packages with open vulnerabilites! ($total > $thresh for '$search')"
        echo ""
        echo "$out"
        echo ""
        return 1
    fi
}

#
# Main
#

skip_devel=
if [ "$1" = "--skip-devel" ]; then
    skip_devel="-S"
fi

err=""

# high and higher
check_output 'high|critical' $alert_high_threshold || err="yes"

# medium or more than 5 low
check_output "medium or >5 low" $alert_threshold || err="yes"

# pure heuristics
#check_output "heuristics" $alert_threshold || err="yes"

if [ "$err" = "yes" ]; then
    exit 1
fi
