#!/bin/sh
# Copyright 2009-2018 Canonical, Ltd.
# Authors:
#  Jamie Strandboge <jamie@canonical.com>
#  Kees Cook <kees@ubuntu.com>
#  Marc Deslauriers <marc.deslauriers@canonical.com>
#  Steve Beattie <steve.beattie@canonical.com>

# Based mostly on the kernel_team_merge() from process_cves, except
# without the actual merging; i.e. it doesn't make any changes to the
# local checkout.

set -e

if [ -z "${UCT}" ] ; then
	echo "\$UCT is not set, aborting"
	exit 1
fi

if ! [ -d "${UCT}" ] ; then
	echo "${UCT} is not a directory, aborting"
	exit 1
fi

cd "${UCT}"

kernel_team_merge() {
    kernel_remote='kernel-team'
    kernel_url="https://git.launchpad.net/~canonical-kernel-team/ubuntu-cve-tracker"

    if ! (git remote | grep -q "^${kernel_remote}$") ; then
        git remote add "${kernel_remote}" "${kernel_url}"
    fi
    git fetch -q "${kernel_remote}"
    if ! [ "$(git rev-list HEAD..kernel-team/master --count)" -eq 0 ] ; then
        echo "Missing merge commits from the Kernel Team's CVE Tree"
        git show  "HEAD..${kernel_remote}/master"
    fi
}

kernel_team_merge
