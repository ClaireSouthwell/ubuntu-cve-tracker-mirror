#!/usr/bin/python

# Author: Kees Cook <kees@ubuntu.com>
# Author: Jamie Strandboge <jamie@ubuntu.com>
# Copyright (C) 2005-2008 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

import sys
import re
import cve_lib
from urllib import quote
from cgi import escape
from time import gmtime, strftime

# FIXME: detect and safely quote URLs

cvefile = sys.argv[1]
data = cve_lib.load_cve(cvefile)

is_retired = False
if re.match('^retired/',cvefile):
    is_retired = True

#import pprint
#pp = pprint.PrettyPrinter(indent=4)
#pp.pprint(data)

cve = data['Candidate']

print '''<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>%s in Ubuntu</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="author" content="Canonical Ltd, and others" />
<meta name="description" content="Ubuntu CVE Entry" />
<meta name="copyright" content="Canonical Ltd, and others" />
<style type='text/css' media='all'>

body {
 padding: 0 1em;
 color: #000;
 background-color: #fff;
}

/*
a, a:link, a:visited, a:hover, a:active {
 color: #d90d19;
}
*/

h2.cve {
 border-left: 2px solid #3b2e1e;
 padding: 0.1em 0.5em;
 color: #3b2e1e;
}

.item div.field, .pkg div.field {
 margin-top: 1em;
 font-weight: bold;
 text-decoration: underline;
 color: #3b2e1e;
}

div.value, div.notes-value,  div.negligible-value, div.low-value, div.medium-value, div.high-value, div.critical-value, div.patches {
 font-size: 90%%;
 margin-left: 0.3em;
 margin-top: 0.1em;
}

div.patches {
 margin-top: 1em;
}

span.safe {
 color: green;
}

span.pending {
 color: #0f0;
}

div.high-value, div.critical-value, span.vuln {
 font-weight: bold;
 color: #d90d19;
}

div.medium-value {
 font-weight: bold;
 color: orange;
}

table {
 border-collapse: collapse;
 font-size: 90%%;
}

td, th {
 border-width: 0;
 vertical-align: top;
}

.pkg td span {
 font-weight: bold;
 font-size: 90%%;
 padding-left: 1em;
}

div.notes-value {
 font-family: monospace;
}

ul, ol, .pkg table {
 margin: 0.2em 0 0 1em;
 padding: 0.2em 0 0 0;
}
ol {
 margin-left: 1.5em;
}

ul li {
 font-size: 90%%;
 padding: 0;
 margin: 0;
 list-style-type: none;
}

div#footer {
 width: 100%%;
 font-size: smaller;
 padding: 1em;
 text-align: center;
}

</style>
</head>

<body>
''' % (escape(cve))

# CVE cross links
heading = quote(cve)
if is_retired:
    heading += ' (retired)'
print '<h2 class="cve">%s</h2>' % (heading)

# Handle "free-form" text
for field in ['Priority','Description','Ubuntu-Description','References','Bugs','Notes','Assigned-to']:
    if not data.has_key(field):
        continue
    text = data[field].strip()
    if len(text) == 0:
        continue

    escaped_body = ""
    for line in text.split('\n'):
        if (field == "References" or field == "Bugs") and re.match('^http[s]?://', line):
            escaped_body += '<a href="%s">%s</a><br />' % (quote(escape(line), ':/?&;='), escape(line))
        else:
            escaped_body += '%s<br />' % (escape(line))

    value_class = "value"
    if field == 'Notes':
        value_class = 'notes-value'


    if field == "Priority":
        escaped_body = escaped_body.capitalize()
        if escape(line).lower() == "negligible":
            value_class = "negligible-value"
        elif escape(line).lower() == "low":
            value_class = "low-value"
        elif escape(line).lower() == "medium":
            value_class = "medium-value"
        elif escape(line).lower() == "high":
            value_class = "high-value"
        elif escape(line).lower() == "critical":
            value_class = "critical-value"
        else:
            value_class = "value"
    
    
    print '<div class="item"><div class="field">%s</div> <div class="%s">%s</div></div>' % (escape(field),value_class,escaped_body)

# Handle package logic
for pkg in data['pkgs']:
    print '<div class="pkg">'
    print '<div class="field">Package</div><div class="value">Source: <a href="https://launchpad.net/distros/ubuntu/+source/%s">%s</a> (<a href="http://packages.ubuntu.com/search?suite=all&amp;section=all&amp;arch=any&amp;searchon=sourcenames&amp;keywords=%s">PTS</a>)</div>' % (quote(pkg),quote(pkg),escape(pkg))

    print '<table>'

    # move upstream to the front of the list...
    releases = [] + cve_lib.releases
    releases.insert(0,releases.pop())
    for release in releases:
        if not data['pkgs'][pkg].has_key(release):
            continue

        relname = release
        if relname == 'devel':
            relname = cve_lib.devel_release

        status = data['pkgs'][pkg][release][0]
        notes  = data['pkgs'][pkg][release][1]

        name = '%s' % (escape(release).capitalize())
        if status != 'DNE' and relname != 'upstream':
            name = '<a href="https://launchpad.net/ubuntu/%s/+source/%s">%s</a>' % (quote(relname),quote(pkg),escape(relname).capitalize())

        status_class = "default"
        if status in ['needed','active','deferred']:
            status_class = "vuln"
        elif status == 'released' or status == 'not-affected' or status == "DNE":
            status_class = "safe"
        elif status == 'pending':
            status_class = "pending"

        print '<tr><td>%s:</td><td><span class="%s">%s</span>' % (name, status_class, status)
        if len(notes):
            print '(%s)' % (escape(notes))
        print '</td></tr>'
    print '</table>'

    patches = 'Patches_%s' % (pkg)
    if data.has_key(patches):
        entries = data[patches]
        if entries != "":
            print '<div class="patches">Patches:</div>'
            print '<table>'
        for patch in entries.split('\n'):
            if not ':' in patch:
                continue
            source, url = patch.split(':',1)
            if re.match('^(ftp|http)[s]?://', url):
                print '<tr><td>%s:</td><td><a href="%s">%s</a></td></tr>' % (escape(source),quote(url),escape(url))
            else:
                print '<tr><td>%s:</td><td>%s</td></tr>' % (escape(source),escape(url))
        if entries != "":
            print '</table>'
    print '</div>'

print '<div class="item">'
print '<div class="field">More Information</div>'
print '<ul class="links"><li><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=%s">Mitre</a></li><li><a href="http://nvd.nist.gov/nvd.cfm?cvename=%s">NVD</a></li><li><a href="https://launchpad.net/bugs/cve/%s">Launchpad</a></li><li><a href="http://security-tracker.debian.net/tracker/%s">Debian</a></li></ul>' % (quote(cve),quote(cve),quote(cve),quote(cve))
print '</div>'

print '<div id="footer">'
print '&copy; Canonical Ltd. 2007-%s' % (strftime("%Y", gmtime()))
print '</div>'
print '''</body>
</html>
'''    
