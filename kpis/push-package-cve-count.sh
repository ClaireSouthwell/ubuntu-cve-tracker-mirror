#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the packages with the most number of CVEs remediated per package for
# Trusty, Xenial and Bionic
set -e

# shellcheck source=common.sh
. "$(dirname "${BASH_SOURCE[0]}")/common.sh"

# move to UCT so we don't fetch the db in reviewed/
pushd "${UCT:-/home/ubuntu-security/git-pulls/cve-tracker}"
./scripts/fetch-db database.pickle.bz2 1>/dev/null 2>&1

# number of packages to report
N=15
# TODO - this should really run from reviewed/
for dist in $RELEASES; do
  ./scripts/report-packages.py --action plot "$dist" | grep -v linux- | sort -n -k 8 | tail -n $N | while read -r pkg _ _ _ _ _ _ pkgtotal
  do
    DATA="security_package_cve_count_$dist $pkgtotal"
    JOB="security_job"
    INSTANCE="$pkg"
    push_to_prometheus "$DATA" "$JOB" "$INSTANCE"
  done
done

popd
