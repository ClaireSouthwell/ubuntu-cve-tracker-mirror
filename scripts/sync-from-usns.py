#!/usr/bin/python
import cPickle, sys, os, os.path, cve_lib

def load_database(filename):
    filename = os.path.expanduser(filename)
    if not os.path.isfile(filename):
        return {}
    file = open(filename)
    database = cPickle.load(file)
    file.close()
    return database

cves = dict()

db = load_database(sys.argv[1])

for usn in db:
    if not db[usn].has_key('cves'):
        continue
    for cve in db[usn]['cves']:
        if not cve.startswith('CVE-'):
            continue
        filename = 'active/%s' % (cve)
        if os.path.exists(filename):
            if not cves.has_key(cve):
                ret, data = cve_lib.load_cve(filename)
                if ret != cve_lib.EXIT_OKAY:
                    print >>sys.stderr, "Could not load %s" % (filename)
                    continue
                cves.setdefault(cve,data)

            for rel in db[usn]['releases']:
                if not db[usn]['releases'][rel].has_key('sources'):
                    #print >>sys.stderr, "Broken USN: %s (no sources for %s?!)" % (usn, rel)
                    continue
                for src in db[usn]['releases'][rel]['sources']:
                    if not cves[cve]['pkgs'].has_key(src) or cves[cve]['pkgs'][src].has_key(rel):
                        print >>sys.stderr, "USN-%s touches %s in %s with %s (but is not listed in %s)" % (usn, src, rel, cve, filename)

#            print '%s: %s still active' % (usn, cve)
