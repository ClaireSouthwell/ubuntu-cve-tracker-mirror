#!/bin/bash
# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Push mailing list subscribers to prometheus for KPIs (requires passwords to
# be in ~/.ubuntu-cve-tracker.conf as per README)
set -e

# shellcheck source=common.sh
. "$(dirname "${BASH_SOURCE[0]}")/common.sh"

timestamp=$(date -u +%s)

pushd "$(dirname "${BASH_SOURCE[0]}")"
# push mailing list subscribers
echo "Querying number of subscribers for ubuntu-hardened list..."
# shellcheck disable=SC2154
COUNT=$(./get-total-mailman-subscribers.sh ubuntu-hardened "$ubuntu_hardened_admin_password")

DATA="mailing_list_subscribers ubuntu_hardened=$COUNT"
push_to_influx "$DATA" "$timestamp"

echo "Querying number of subscribers for ubuntu-security-announce list..."
# shellcheck disable=SC2154
COUNT=$(./get-total-mailman-subscribers.sh ubuntu-security-announce "$ubuntu_security_announce_admin_password")

DATA="mailing_list_subscribers ubuntu_security_announce=$COUNT"
push_to_influx "$DATA" "$timestamp"
popd
