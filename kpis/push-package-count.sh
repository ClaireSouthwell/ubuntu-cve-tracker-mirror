#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of updated packages per release to prometheus for the KPIs
set -e

# shellcheck source=common.sh
. "$(dirname "${BASH_SOURCE[0]}")/common.sh"

# move to UCT so we don't fetch the db in reviewed/
pushd "${UCT:-/home/ubuntu-security/git-pulls/cve-tracker}"
./scripts/fetch-db database.pickle.bz2

# use one timestamp for all data points
timestamp=$(date -u +%s)
for dist in $RELEASES; do
  count=$(./scripts/report-packages.py --action plot $dist | wc -l)
  DATA="source_package_updates $dist=$count"
  push_to_influx "$DATA" "$timestamp"
done
popd
