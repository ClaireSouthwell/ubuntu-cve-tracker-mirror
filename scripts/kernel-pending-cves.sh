#!/bin/sh
# Copyright 2020 Canonical, Ltd
# Author: Steve Beattie <steve.beattie@canonical.com>
# License: GPLv3

# This script is used for reporting and fixing up kernels that were
# addressed in an update before the CVE was assigned for it. The kernel
# triage bot will mark it as pending with a version that predates the
# last USN issued, so either report or fixup the pending CVE statuses.
#
# Sample usage:
#   scripts/kernel-pending-cves.sh linux-aws bionic 4.15.0-1066.70
# or
#   scripts/kernel-pending-cves.sh -u linux-aws bionic 4.15.0-1066.70
#

set -e

DO_UPDATE=

while getopts "u" opt
do
    case "$opt" in
        u) DO_UPDATE=true;;
        h) help ; exit 0;;
    esac
done
shift $(expr $OPTIND - 1)

kernel="$1"
release="$2"
version="$3"

if [ -z "$DO_UPDATE" ] ; then
    scripts/report-pending-fixes -r "$release" "$kernel" 0 "$version"  -s | grep pending
else
    scripts/report-pending-fixes -r "$release" "$kernel" 0 "$version"  -s | grep pending \
    | while read -r line ; do
         CVE=$(echo $line | cut -f1 -d' ')
	 _kernel=$(echo $line | cut -d ' ' -f 2)
	 _release=$(echo $line | cut -d ' ' -f3)
	 _version=$(echo $line | cut -d' ' -f5)
	 ./scripts/mass-cve-edit -p "$_kernel" -r "$_release" -s released -v "$_version" "$CVE"
    done
fi
