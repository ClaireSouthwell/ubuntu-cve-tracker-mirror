#!/usr/bin/perl -w
#
# cve_packages [-t]
#

use strict;

my %verylow;
my %low;
my %medium;
my %high;
my %critical;
my %untriaged;
my %packages;

my $totals_only;
if ($#ARGV == 0 and $ARGV[0] eq "-t") {
	shift(@ARGV);
	$totals_only = "yes";
}

open CVES, "../scripts/ubuntu-table --supported |" or die;

while (<CVES>) {
	my @parts = split();

	my $pkgname = $parts[1];
	$pkgname =~ s/://g;
	my $priority = $parts[$#parts];	

	(defined($packages{$pkgname}) and $packages{$pkgname} = 1) or $packages{$pkgname}++;

	if ($priority =~ /^untriaged$/) {
		(defined($untriaged{$pkgname}) and $untriaged{$pkgname} = 1) or $untriaged{$pkgname}++;
	}
	if ($priority =~ /^very-low$/) {
		(defined($verylow{$pkgname}) and $verylow{$pkgname} = 1) or $verylow{$pkgname}++;
	}
	if ($priority =~ /^low$/) {
		(defined($low{$pkgname}) and $low{$pkgname} = 1) or $low{$pkgname}++;
	}
	if ($priority =~ /^medium$/) {
		(defined($medium{$pkgname}) and $medium{$pkgname} = 1) or $medium{$pkgname}++;
	}
	if ($priority =~ /^high$/) {
		(defined($high{$pkgname}) and $high{$pkgname} = 1) or $high{$pkgname}++;
	}
	if ($priority =~ /^critical$/) {
		(defined($critical{$pkgname}) and $critical{$pkgname} = 1) or $critical{$pkgname}++;
	}
}

foreach my $k (sort keys(%packages)) {
	if (defined($ARGV[0])) {
		my $display = 0;
		foreach my $arg (@ARGV) {
			$display = 1 if ($arg eq $k);
		}
		next if (!$display);
	}
	print "$k: $packages{$k}";
	if (not $totals_only) {
		print " total";
		defined ($untriaged{$k}) and print ", $untriaged{$k} untriaged";
		defined ($verylow{$k}) and print ", $verylow{$k} very-low";
		defined ($low{$k}) and print ", $low{$k} low";
		defined ($medium{$k}) and print ", $medium{$k} medium";
		defined ($high{$k}) and print ", $high{$k} high";
		defined ($critical{$k}) and print ", $critical{$k} critical";
	}
	print "\n";
}

close (CVES);

