#!/usr/bin/env python
# Copyright 2008, Canonical, Ltd
# Author: Kees Cook <kees@ubuntu.com>
# License: GPLv3
#
# This will update any "TODO" items in the secure-testing Debian CVE list
# from the Ubuntu CVE tracker.
from cve_lib import *
import sys
import source_map

config = read_config()
if len(sys.argv) == 2:
    debian_cve_list = sys.argv[1]
else:
    debian_cve_list = os.path.join(config['secure_testing_path'], "data/CVE/list")

print "Loading Debian Sources ..."
debian_sources = source_map.load_debian(config['debian_mirror'])['testing']

# Load known Debian CVEs
debian = load_debian_cves(debian_cve_list)
ignored_reasons = load_ignored_reasons('ignored/not-for-us.txt')

# Load known, non-embargoed CVEs
(active, embargoed) = get_cve_list()
known = [cve for cve in active if cve not in embargoed]
active = None
embargoed = None

# Look for public CVEs we know about that Debian does not yet and add them.
for cve in sorted(ignored_reasons.keys()):
    if not debian.has_key(cve):
        # FIXME: load desc (it's ignored, so no desc to load...)
        desc = ''
        prepend_debian_cve(debian_cve_list, cve, desc)

update_debian_todo_cves(ignored_reasons, known, debian_cve_list, debian_sources, verbose=True)
