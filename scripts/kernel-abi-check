#!/usr/bin/python
# Checks the kernel ABI versions to make sure there are no mismatches
# between -security and -updates.
#
# Copyright (C) 2009-2016 Canonical, Ltd.
# Author: Kees Cook <kees@ubuntu.com>
from __future__ import print_function

import argparse
import os
import subprocess
import sys

from cve_lib import (meta_kernels, lookup_glitch_version, ignore_kernel_mabi,
                     is_active_release, is_active_esm_release)

try:
    import lpl_common
except ImportError:
    uqt_dir = os.getenv('UQT')
    sys.path.append(os.path.join(os.getenv('UQT'), 'common/'))
    try:
        import lpl_common
    except ImportError:
        print("lpl_common.py seems to be missing. Make sure $UQT environment variable is set properly", file=sys.stderr)
        sys.exit(1)

parser = argparse.ArgumentParser()
parser.add_argument("-v", "--verbose", help="Show matches", action='store_true')
parser.add_argument("--ignore-usn", help="Ignore need for USNs", action='store_true')
parser.add_argument("--ignore-abi", help="Ignore ABI mismatches", action='store_true')
parser.add_argument("--add-proposed", help="check proposed for ABI mismatches", action='store_true')
parser.add_argument("kernel", help="only check specific kernels", nargs="*")
opt = parser.parse_args()

lp = lpl_common.connect()
ubuntu = lp.distributions['ubuntu']
archive = ubuntu.main_archive
pockets = ['Updates', 'Security']
if opt.add_proposed:
    pockets.append('Proposed')


def get_version(src, series, pocket):
    pubs = archive.getPublishedSources(exact_match=True,
                                       source_name=src,
                                       status="Published",
                                       pocket=pocket,
                                       distro_series=series)
    count = 0
    for pub in pubs:
        count += 1
    if count > 1:
        for pub in pubs:
            print(pub.source_package_version, file=sys.stderr)
        raise ValueError(count)
    if count == 1:
        return pubs[0].source_package_version
    return None


def get_usn_version(src, release):
    topdir = os.environ['UCT']
    if 'UCT_REVIEWED' in os.environ:
        topdir = os.environ['UCT_REVIEWED']
    cmd = [os.path.join(topdir, 'scripts/report-version.py'),
           src, release]
    version = subprocess.Popen(cmd, stdout=subprocess.PIPE).communicate()[0].strip()
    # Handle any pocket glitch remappings
    glitch_version = lookup_glitch_version(src, release, version)
    if glitch_version:
        if opt.verbose:
            print('Pretending that %s %s is really %s for %s' % (release, version, glitch_version, src), file=sys.stderr)
        version = glitch_version
    return version


def package_abi(version):
    return int(version.split('-').pop().split('.', 1)[0])


def meta_abi(version, offset=-2):
    return int(version.split('.').pop(offset))


# The "srcs" list must have the main kernel listed first, with ABI tracked
# packages coming after it.
def pocket_abis_match(release, suffix, srcs, metas):
    global opt

    series = ubuntu.getSeries(name_or_version=release)

    pkg = dict()
    meta = dict()
    for pocket in pockets:
        for src in srcs:
            pkg.setdefault(src, dict())
            pkg[src].setdefault(pocket, dict())
            #print('fetching %s in %s %s ...' % (src, release, pocket))
            pkg[src][pocket]['name'] = src
            pkg[src][pocket]['version'] = get_version(src, series, pocket)
            if not pkg[src][pocket]['version']:
                pkg[src][pocket]['version'] = '0.0.0.0'

        # Add metas
        for src in metas:
            meta.setdefault(src, dict())
            meta[src].setdefault(pocket, dict())
            meta[src][pocket]['name'] = src
            meta[src][pocket]['version'] = get_version(src, series, pocket)
            if not meta[src][pocket]['version']:
                if opt.verbose:
                    print('%s missing in %s %s' % (src, release, pocket), file=sys.stderr)
                meta[src][pocket]['version'] = '0.0.0.0'

    rc = True

    # Check for primary kernel versions in -security that do not have a USN
    if not opt.ignore_usn:
        pocket = 'Security'
        src = srcs[0]
        last_usn = get_usn_version(src, release)
        if not pkg[src][pocket]['version'] in ['0.0.0.0', last_usn]:
            rc = False
            print("USN needed: %s %s: %s (last USN: %s)" % (release, pkg[src][pocket]['name'], pkg[src][pocket]['version'], last_usn), file=sys.stderr)

    if opt.ignore_abi:
        return rc

    # Check for ABI mismatches
    for src in srcs:
        for pocket in pockets:
            if not pkg[src][pocket]['version']:
                raise ValueError('missing %s in %s %s' % (src, release, pocket))

            abi = package_abi(pkg[src][pocket]['version'])

            for name in sorted(meta.keys()):
                mabi = meta_abi(meta[name][pocket]['version'])
                meta_ver = meta[name][pocket]['version']
                if meta[name][pocket]['version'] == "0.0.0.0":
                    meta_ver += " (DNE)"

                # Hack for different format and out of sync ABI on dapper
                if (release == 'dapper'):
                    mabi = meta_abi(meta[name][pocket]['version'], -1)
                    # no longer out of sync as of 2.6.15.57
                    if mabi < 57:
                        mabi -= 1

                # Allow certain ABIs to be ignored
                if ignore_kernel_mabi(meta[name][pocket]['name'], release, meta[name][pocket]['version']):
                    if opt.verbose:
                        print("skip: ABI ignored for %s-%s: %d == %d (%s %s vs %s %s)" % (release, pocket.lower(), mabi, abi, meta[name][pocket]['name'], meta_ver, pkg[src][pocket]['name'], pkg[src][pocket]['version']))
                    continue

                if abi != mabi:
                    rc = False
                    print("FAIL: ABI mismatch in %s-%s: %d != %d (%s %s vs %s %s)" % (release, pocket.lower(), mabi, abi, meta[name][pocket]['name'], meta_ver, pkg[src][pocket]['name'], pkg[src][pocket]['version']), file=sys.stderr)
                elif opt.verbose:
                    print("ok: ABI matches in %s-%s: %d == %d (%s %s vs %s %s)" % (release, pocket.lower(), mabi, abi, meta[name][pocket]['name'], meta_ver, pkg[src][pocket]['name'], pkg[src][pocket]['version']))

    #print("pocket_abis_match(%s, %s, %s, %s, %s) returned %s" % (release, suffix, srcs, metas, ignored, rc))
    return rc


ok = True

# The following table is loosely based on
# https://wiki.ubuntu.com/Kernel/Dev/ABIPackages and
# https://wiki.ubuntu.com/Kernel/Dev/TopicBranches
# the version number in the second parameter isn't currently used in the
# script.

wanted_kernels = set(opt.kernel)

for (release, srcs, meta, suffix) in meta_kernels.get_next_kernel():
    if len(wanted_kernels) > 0 and len(wanted_kernels.intersection(set(srcs))) == 0:
        continue
    # FIXME - need to figure out lookups for esm kernel versions; until
    # then skip them to avoid email noise
    #if is_active_release(release) or is_active_esm_release(release):
    #
    # don't check end of life releases
    if is_active_release(release):
        if not pocket_abis_match(release, suffix, srcs, meta):
            ok = False

if ok:
    sys.exit(0)
else:
    sys.exit(1)
