#!/bin/sh
# Copyright 2011-2012 Canonical, Ltd
# Author: Jamie Strandboge <jamie@canonical.com>
# License: GPLv3
set -e

#
# Configuration
#
if [ -z "$UCT" ]; then
    echo "ERROR: 'UCT' not set." >&2
    exit 1
fi

if [ ! -d "$UCT" ]; then
    echo "ERROR: '$UCT' does not exist." >&2
    exit 1
fi

cd "$UCT"
if [ ! -x "./scripts/cve_packages" ]; then
    echo "ERROR: Could not find executable './scripts/cve_packages'" >&2
    exit 1
fi

alert_threshold=10
alert_high_threshold=0
alert_ignore="linux|webkit|qt4-x11|qtwebkit-source|firefox|thunderbird|xulrunner|PARTNER"

#
# Helpers
#
check_output() {
    search=$1
    thresh=$2
    cve_packages_args="-m -a --deferred-days=30"

    out=""
    if echo "$search" | grep -q "high" || echo "$search" | grep -q "critical" ; then
        # never ignore anything high or critical in our list, even if only
        # in our devel release
        out=`./scripts/cve_packages $cve_packages_args | grep '^[0-9]' | egrep "$search" | sort -n`
        if [ -z "$out" ]; then
            return
        fi
    else
        out=`./scripts/cve_packages $skip_devel $cve_packages_args | egrep -v "($alert_ignore)" | grep '^[0-9]' | egrep "$search" | sort -n`
        if [ -z "$out" ]; then
            echo "ERROR: No cve_packages output!" >&2
            exit 1
        fi
    fi

    total=$(echo "${out}" | wc -l)
    if [ ${total} -gt ${thresh} ]; then
        echo "WARNING: too many packages with open vulnerabilites! ($total > $thresh for '$search')"
        echo ""
        echo "$out"
        echo ""
        return 1
    fi
}

#
# Main
#

skip_devel=
if [ "$1" = "--skip-devel" ]; then
    skip_devel="-S"
fi

err=""

# high and higher
check_output 'high|critical' $alert_high_threshold || err="yes"

# medium
check_output medium $alert_threshold || err="yes"

if [ "$err" = "yes" ]; then
    exit 1
fi
