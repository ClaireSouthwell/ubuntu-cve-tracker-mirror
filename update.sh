#!/bin/bash
set -e
cd /home/ubuntu-security/graphing
REL=lucid
INDEX=11

# Generate supported binary package counts data
COUNT=$(zgrep ^Package: /srv/archive.ubuntu.com/ubuntu/dists/$REL/{main,restricted}/binary-i386/Packages.gz | wc -l)
echo "$REL $INDEX $COUNT" > $REL.data

cat supported.data.template > supported.data
LAST=$(tail -n1 supported.data.template | cut -c2-)
echo $LAST $COUNT >> supported.data

# Generate supported source package counts data
COUNT=$(zgrep ^Package: /srv/archive.ubuntu.com/ubuntu/dists/$REL/{main,restricted}/source/Sources.gz | wc -l)
echo "$REL $INDEX $COUNT" > ${REL}-src.data

cat supported-src.data.template > supported-src.data
LAST=$(tail -n1 supported-src.data.template | cut -c2-)
echo $LAST $COUNT >> supported-src.data

# Plot historical package counts
./plot.py | ./gnuplot

# Plot supported packages
./gnuplot < supported.plot

# Publish!
cp packages.png sources.png supported.png supported-src.png ~/public_html/graphs/


# Graph Open CVEs
NOW=$(date +'%Y-%m-%d')
CURRENT=$(echo -n "$NOW "; cd /home/ubuntu-security/bzr-pulls/cve-tracker; ./scripts/report-todo-plot -S)
cp CVE.data.template CVE.data
if [ $(date +%a) = "Sun" ] && ! grep -q ^"$NOW" CVE.data.template; then
    # Save weekly information as a snapshot
    echo "$CURRENT" >> CVE.data.template
fi
echo "$CURRENT" >> CVE.data
./gnuplot < open-cves.plot

XSTART=$(date -d "6 months ago" +%Y-%m-%d)
perl -p -e "s/^set xrange.*/set xrange [\"$XSTART\":]/;" open-cves-6mon.plot.template > open-cves-6mon.plot
./gnuplot < open-cves-6mon.plot

# Publish!
cp open-cves.png open-cves-6mon.png ~/public_html/cve/


# Graph published USN counts
XSTART=$(date -d "6 months ago" +%Y-%m)
perl -p -e "s/^set xrange.*/set xrange [\"$XSTART\":]/;" usns-6mon.plot.template > usns-6mon.plot
~/bin/usn.sh --db ~/public_html/usn/database.pickle --list-graph > USN.data
./gnuplot < usns.plot
./gnuplot < usns-6mon.plot
# Publish!
cp usns.png usns-6mon.png ~/public_html/graphs/


# Graph published CVE counts/priorities
(cd ~/bzr-pulls/cve-tracker && ./scripts/plot-usns.py --target cve) > cve-updates.data
perl -p -e "s/^set xrange.*/set xrange [\"$XSTART\":]/;" cve-updates-6mon.plot.template > cve-updates-6mon.plot
./gnuplot < cve-updates.plot
./gnuplot < cve-updates-6mon.plot
# Publish!
cp cve-updates.png cve-updates-6mon.png ~/public_html/graphs/
