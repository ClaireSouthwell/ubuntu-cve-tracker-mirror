#!/bin/sh

set -e

print_key() {
	cat <<EOM
<table>
<tr><th>Key</th></tr>
<tr class="critical">
 <td class="needed">Critical</td>
</tr>
<tr class="high">
 <td class="needed">High</td>
</tr>
<tr class="medium">
 <td class="needed">Medium</td>
</tr>
<tr class="low">
 <td class="needed">Low</td>
</tr>
<tr class="unimportant">
 <td class="needed">Unimportant</td>
</tr>
<tr class="needs-triage">
 <td class="needed">Severity unknown (needs triage)</td>
</tr>
<tr>
 <td class="pending">Pending</td>
</tr>
<tr>
 <td class="released">Not Vulnerable</td>
</tr>
</table>
EOM
}

cat <<EOM
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Ubuntu CVE Tracker</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" >

<style type='text/css' media='all'>
h2 {
 margin-top: 2em;
}

p.note {
 font-size: smaller;
 margin: 0.2em;
}

table {
 border-collapse: collapse;
 border: 2px solid black;
}
th {
 border-bottom: 2px solid black;
}

/* basic styling */
td {
 border: 1px solid black;
 text-align: center;
 padding-left: 0.5em;
 padding-right: 0.5em;
 background-color: white;
 font-size: smaller;
}

/* critical and high */
tr.critical td.needed, tr.critical td.needs-triage, tr.high td.needed, tr.high td.needs-triage {
 background-color: red;
}

/* medium */
tr.medium td.needed, tr.medium, td.needs-triage {
 background-color: orange;
}

/* low */
tr.low td.needed, tr.low td.needs-triage {
 background-color: yellow;
}

/* unimportant */
tr.unimportant td.needed, tr.unimportant td.needs-triage {
 background-color: #ddd;
}

/* released, DNE, not-affected */
td.released, td.DNE, td.not-affected {
 background-color: green;
}

/* untriaged */
tr.untriaged td.needed, tr.untriaged, td.needs-triage {
 background-color: #f6f;
}

/* pending */
td.pending {
 background-color: #0f0;
}

</style>
</head>

<body>
<h1>Ubuntu CVE Tracker</h1>
EOM
print_key
echo "<h2>Main</h2>"
./scripts/ubuntu-table --html --supported 2>/dev/null | egrep '(<table>|</table>|<th>|SUPPORTED)' | egrep -v 'EMBARGOED'
echo "<p class="note">* supported</p>"

echo "<h2>Commercial</h2>"
./scripts/ubuntu-table --html --supported 2>/dev/null | egrep '(<table>|</table>|<th>|COMMERCIAL)' | egrep -v 'EMBARGOED'
echo "<p class="note">* supported</p>"

if [ -h "./embargoed" ]; then
	echo "<h2>Embargoed</h2>"
	./scripts/ubuntu-table --html --supported 2>/dev/null | egrep '(<table>|</table>|<th>|EMBARGOED)'
	echo "<p class="note">* supported</p>"
fi

echo "<h2>Universe</h2>"
./scripts/ubuntu-table --html --supported 2>/dev/null | egrep -v '(COMMERCIAL|SUPPORTED|EMBARGOED)' | egrep -v 'EMBARGOED'

cat <<EOM
</table>
</body>
</html>
EOM

