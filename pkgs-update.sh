#!/bin/bash
set -e
cd /home/ubuntu-security/graphing
TRACKER=/home/ubuntu-security/bzr-pulls/cve-tracker

# Affected software counts
export NAMED=10
echo '<html><head><title>CVE counts per release per package</title></head><body>' > ~/public_html/graphs/pkgs-report.html.new
for REL in $(./supported-list.py | tac) ; do
	export REL

	(
	(cd "$TRACKER" && ./scripts/report-packages.py --action plot $REL) | sort -n -k 8 | awk '{print $1 " " $8}' | tail -n $NAMED; echo -n "others "
	(cd "$TRACKER" && ./scripts/report-packages.py --action plot $REL) | sort -n -k 8 | head -n -$NAMED | awk '{ sum+=$8 }END{print sum}'
	) | "$TRACKER"/scripts/pie-chart.py pkgs-$REL.png "$REL CVE fixes published per package"
	echo '<img src="'pkgs-$REL.png'" /><hr />' >> ~/public_html/graphs/pkgs-report.html.new
	cp pkgs-$REL.png ~/public_html/graphs/
done
echo '</body></html>' >> ~/public_html/graphs/pkgs-report.html.new
mv ~/public_html/graphs/pkgs-report.html.new ~/public_html/graphs/pkgs-report.html
