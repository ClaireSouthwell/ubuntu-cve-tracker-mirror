#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of CVEs remediated per package for Trusty and Xenial
# TODO could be looped rather than duplicated

cd $UCT
./scripts/fetch-db database.pickle.bz2

./scripts/report-packages.py --action plot trusty | while read pkg a b c d e f pkgtotal
do
  if [ $pkgtotal -gt 14 ]; then
    if [[ $pkg != linux-* ]]; then
      echo "security_package_cve_count_fifteen_trusty $pkgtotal" | curl --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_job/instance/$pkg
      echo "trusty: " $pkgtotal $pkg
      sleep 5 
    fi
  fi
done

./scripts/report-packages.py --action plot xenial | while read pkg a b c d e f pkgtotal
do
  if [ $pkgtotal -gt 14 ]; then
    if [[ $pkg != linux-* ]]; then
      echo "security_package_cve_count_fifteen $pkgtotal" | curl --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_job/instance/$pkg
      echo "xenial: " $pkgtotal $pkg
      sleep 5 
    fi
  fi
done
