#!/bin/bash

# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the number of updated packages done as part of esm per release to
# prometheus for the KPIs
set -e

. "$HOME"/.ubuntu-cve-tracker.conf

echo "Checking we can resolve influxdb hostname..."
nslookup influxdb.security.kpi.internal 1>/dev/null 2>&1 || (echo "Unable to resolve host influxdb.security.kpi.internal - you must be connected to the Canonical VPN to use this script." && exit 1)

PASSWORD=${influxdb_security_password}
while [ -z "$PASSWORD" ]; do
  echo -n "Enter password for user 'security' influxdb: "
  read -r -s PASSWORD
  # newline after password
  echo ""
done

# move into the directory which contains this script
pushd $(dirname "${BASH_SOURCE[0]}")

pushd ..
for dist in trusty xenial bionic; do
  # strip header off table - start at line 3
  report=$(./scripts/report-released-packages -e -r $dist | tail -n +3)
  total=$(echo "$report" | wc -l)
  ppa=$(echo "$report" | grep PPA | wc -l)
  universe=$((total-ppa))
  timestamp=$(date -u +%s)
  DATA="esm_total_source_package_updates $dist=$total $timestamp"
  echo "Pushing \"$DATA\" for $(date -d@$timestamp -u) to Influx..."
  RESPONSE=$(http_proxy=; curl -s -o /dev/null -w "%{http_code}" -i -XPOST "http://influxdb.security.kpi.internal:8086/write?db=security&u=security&p=$PASSWORD;precision=s" --data-binary "$DATA")
  if [ "$RESPONSE" != 204 ]; then
    echo "Failed to push data: $RESPONSE"
    exit 1
  fi
  DATA="esm_ppa_source_package_updates $dist=$ppa $timestamp"
  echo "Pushing \"$DATA\" for $(date -d@$timestamp -u) to Influx..."
  RESPONSE=$(http_proxy=; curl -s -o /dev/null -w "%{http_code}" -i -XPOST "http://influxdb.security.kpi.internal:8086/write?db=security&u=security&p=$PASSWORD;precision=s" --data-binary "$DATA")
  if [ "$RESPONSE" != 204 ]; then
    echo "Failed to push data: $RESPONSE"
    exit 1
  fi
  DATA="esm_universe_source_package_updates $dist=$universe $timestamp"
  echo "Pushing \"$DATA\" for $(date -d@$timestamp -u) to Influx..."
  RESPONSE=$(http_proxy=; curl -s -o /dev/null -w "%{http_code}" -i -XPOST "http://influxdb.security.kpi.internal:8086/write?db=security&u=security&p=$PASSWORD;precision=s" --data-binary "$DATA")
  if [ "$RESPONSE" != 204 ]; then
    echo "Failed to push data: $RESPONSE"
    exit 1
  fi
done
popd
popd
