#!/usr/bin/python
import glob, sys, optparse, cve_lib, os, re
import pprint

EXIT_FAIL = 1
EXIT_OKAY = 0

parser = optparse.OptionParser()
parser.add_option("-v", "--verbose", dest="verbose", help="Enable verbose reporting", action='store_true')
(opt, args) = parser.parse_args()

code = EXIT_OKAY

add_path = False
if len(args) == 0:
    for dir in ['active','retired','ignored']:
        args += sorted(glob.glob('%s/CVE-*' % (dir)))
    if os.path.islink('embargoed'):
        args += sorted(glob.glob('embargoed/EMB-*'))
else:
    add_path = True

for cve in args:
    if add_path:
        if re.match(r'EMB-', cve):
            cve = os.path.join("./embargoed", cve)
        else:
            cve = os.path.join("./active", cve)
        
    ret, data = cve_lib.load_cve(cve)
    if ret == EXIT_FAIL:
        code = EXIT_FAIL
    elif opt.verbose:
        pp = pprint.PrettyPrinter(indent=4)
        pp.pprint(data)

if code == EXIT_OKAY and opt.verbose:
    print 'OK: %d CVEs' % (len(args))
sys.exit(code)
