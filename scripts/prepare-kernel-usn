#!/bin/bash
# Author: Kees Cook <kees@ubuntu.com>
# Copyright: 2011 Canonical, Ltd
# License: GPLv3
#
# Walk through the steps to do a standard kernel publication using the
# CVE statuses populated in UCT ahead of time.
#
# This script is still in the testing phase...
set -e

REL="$1"
PKG="$2"

if [ -z "$REL" ] || [ -z "$PKG" ]; then
    echo "$0 RELEASE PACKAGE" >&2
    exit 1
fi

DRYRUN=
if [ -n "$3" ] && [ "x$3" = "x-n" ]; then
    DRYRUN=1
fi

cd $UCT

latest=$(./scripts/report-latest-usn-version -r $REL $PKG)
./scripts/report-pending-fixes -D -r $REL $PKG $latest
cves=$(./scripts/report-pending-fixes -r $REL $PKG $latest)

if [ -n "$DRYRUN" ]; then
    USN=$(echo N-1)
else
    USN=$(ssh people.canonical.com "~ubuntu-security/bin/get-next-usn" $REL $PKG)
fi

DIR=/tmp/usn-$REL-$PKG
rm -rf $DIR
$UCT/scripts/sis-changes --ppa ubuntu -r $REL --download $DIR $PKG
cd $DIR
$UCT/scripts/sis-generate-usn --cves $(echo $cves | sed -e 's/ /,/g') --filter-bins '^linux-image-\d' $USN *.changes > ~/new-usn.sh
vi ~/new-usn.sh

if [ -z "$DRYRUN" ]; then
    bash ~/new-usn.sh
    ssh people.canonical.com "~ubuntu-security/bin/check-upload $USN"
fi

echo SRCPKG='"'$SRCPKG'"'
echo USN=$USN
