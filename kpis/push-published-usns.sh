#!/bin/bash
# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Generate and push to the influxdb the number of USNs published over team for
# each release, along with the unique nimber of cves mentioned in those USNs
# for each release

set -e

# shellcheck source=common.sh
. "$(dirname "${BASH_SOURCE[0]}")/common.sh"

DAYS=$(get_missing_days_from_influx "published_usns")

debug "Generating and pushing published USNs (& CVEs) data from last $DAYS days..."

pushd "${UCT:-/home/ubuntu-security/git-pulls/cve-tracker}"
./scripts/fetch-db database.pickle 1>/dev/null 2>&1
while [[ $DAYS -gt 0 ]]; do
  QUERYDATE=$(date --date="today -$DAYS day" +%Y-%m-%d)
  DAYS_1=$((DAYS - 1))
  TZ=UTC
  timestamp="$(date +%s -d "$QUERYDATE")"
  for release in $RELEASES $HISTORIC_RELEASES; do
    ./scripts/report-fixed-cves.py -r $release --before="$timestamp" -s | tail -n1 | while read -r usns _ _ cves _ _; do
      DATA="published_usns $release=$usns"
      push_to_influx "$DATA" "$timestamp"
      DATA="published_usn_cves $release=$cves"
      push_to_influx "$DATA" "$timestamp"
    done
  done                                                                       #
  DAYS=$DAYS_1
done
popd

