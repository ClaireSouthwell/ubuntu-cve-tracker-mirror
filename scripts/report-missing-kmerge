#!/bin/sh
# Copyright 2009-2016 Canonical, Ltd.
# Authors:
#  Jamie Strandboge <jamie@canonical.com>
#  Kees Cook <kees@ubuntu.com>
#  Marc Deslauriers <marc.deslauriers@canonical.com>
#  Steve Beattie <steve.beattie@canonical.com>

# Based mostly on the kernel_team_merge() from process_cves, except
# without the actual merging; i.e. it doesn't make any changes to the
# local checkout.

set -e

kernel_team_merge() {
    kernelteam='lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team'

    if ! bzr missing -q --theirs-only ${kernelteam} ; then
    	echo "Missing merge commits from the Kernel Team's CVE Tree"
        # Find their most recent merge point
        lastmerge=$(bzr missing --mine-only ${kernelteam} | grep revno | cut -d' ' -f2 | tail -n1)
        if [ -n "${lastmerge}" ]; then
            lastmerge=$(( ${lastmerge} - 1 ))
        else
            lastmerge=$(bzr log | head -n10 | grep revno | head -n1 | cut -d' ' -f2)
        fi
        # Extract a diff of what they changed, relative to the merge
        # point
        bzr diff -r${lastmerge} --new=${kernelteam}
    fi
}

kernel_team_merge
