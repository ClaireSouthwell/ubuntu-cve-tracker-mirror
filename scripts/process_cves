#!/bin/sh
# Copyright 2009 Canonical, Ltd.
# Author: Jamie Strandboge <jamie@canonical.com>
#
# Script to help triage CVEs based on Triage Frequency in $UCT/README
#

set -e

uctconf="$HOME/.ubuntu-cve-tracker.conf"
if [ -s "$uctconf" ]; then
    . "$uctconf"
else
    echo "Could not find '$uctconf'" >&2
    exit 1
fi

prev_dir=`pwd`
trap "cd '$prev_dir'" EXIT HUP INT QUIT TERM

cd ${UCT}
action=`LC_TIME=C date +%a`
if [ ! -z "$1" ]; then
    action="$1"
fi

download() {
    url="$1"
    # if http, then download it with wget, otherwise, try to rsync it
    if echo "$url" | grep -q "^http" ; then
        echo "wget -N \"$url\""
        wget -N "$url"
    else
        echo "rsync -v --progress \"$url\" ."
        rsync -v --progress "$url" .
    fi
    echo "---"
}

update_files() {
    download "$mitre_loc/allitems.xml"

    year="2005"
    current_year=`date +%Y`
    while /bin/true ; do
        if [ $year -gt $current_year ]; then
                break
        fi
        download "$nvd_loc/nvdcve-${year}.xml"
        year=$((${year}+1))
    done
    download "http://nvd.nist.gov/download/nvdcve-recent.xml"
}

update_files



case "$action" in
    Mon)
        echo "check-cves nvdcve-2*.xml"
        ./scripts/check-cves nvdcve-2*.xml
        ;;
    Wed)
        echo "check-cves --refresh ..."
        # get PubDate
        ./scripts/check-cves --refresh nvdcve-2*.xml

        # get authoritative descriptions
        ./scripts/check-cves --refresh ./allitems.xml

        # now process new ones
        echo "check-cves ./allitems.xml"
        ./scripts/check-cves ./allitems.xml
        ;;
    Fri)
        echo "check-cves ./nvdcve-recent.xml"
        ./scripts/check-cves ./nvdcve-recent.xml
        ;;
    *)
        echo "check-cves ./nvdcve-recent.xml"
        ./scripts/check-cves ./nvdcve-recent.xml
        ;;
esac

exit 0
