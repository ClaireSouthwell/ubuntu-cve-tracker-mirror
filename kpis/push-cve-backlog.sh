#!/bin/bash
# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the current CVE backlog to prometheus for the KPIs
set -e

# shellcheck source=common.sh
. "$(dirname "${BASH_SOURCE[0]}")/common.sh"

# Since we process the actual CVE files we need to be in UCT itself not reviewed/
pushd "${UCT:-/home/ubuntu-security/git-pulls/cve-tracker}"
timestamp=$(date -u +%s)
./scripts/report-todo-plot -S | while read -r critical high medium low _
do
  for level in critical high medium low; do
    n=${!level}
    DATA="cve_backlog $level=$n"
    push_to_influx "$DATA" "$timestamp"
  done
done

CATEGORY=universe ./scripts/report-todo-plot -S | while read -r critical high medium low _
do
  for level in critical high medium low; do
    n=${!level}
    DATA="cve_backlog_universe $level=$n"
    push_to_influx "$DATA" "$timestamp"
  done
done
popd
