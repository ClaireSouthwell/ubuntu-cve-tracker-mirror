#!/bin/bash -e
# Copyright (C) 2008 Canonical, Ltd.
# Author: Kees Cook <kees@ubuntu.com>
# Author: Jamie Strandboge <jamie@ubuntu.com>
# License: GPLv3
#
# This script attempts to build up statistics for a monthly report on
# security update activity on USNs, triage, and outstanding tasks.
# It is designed to be run on the month _following_ the month one wants
# a report for.  e.g. run this script in April if you want the March report.
#
# By default, report in a more prose-style.  E.g.:
#  The security team had a busy month.  We published 29 Ubuntu Security
#  Notices which fixed 63 security issues (CVEs) across 30 supported
#  packages.  Additionally, we triaged 487 public security vulnerability
#  reports, weeding out only those that applied to Ubuntu.
#
#  For all the supported packages in Ubuntu, there are 67 medium-priority
#  issues and 206 low issues that need to be fixed in 142 packages.
#
#  For all partner packages in Ubuntu, there is 1 medium-priority issue
#  that needs to be fixed in 1 package.
#
#  For all community-supported packages in Ubuntu, there are 7 high-priority
#  issues, 721 medium-priority, and 1005 low-priority issues that need to be
#  fixed in 686 packages.

# Make sure we won't destroy any pending commits
bzr diff >/dev/null || {
    echo "Aborting: uncommitted changes. Please use 'bzr commit' before proceeding" >&2
    exit 1
}

REP_MON=$(date +%B -d 'last month')
REP_MONN=$(date +%m -d 'last month')
REP_YEAR=$(date +%Y -d 'last month')

THIS_MONN=$(date +%m)
THIS_YEAR=$(date +%Y)

echo "Fetching USN publication list..." >&2
USNS=$(echo $(curl -s https://lists.ubuntu.com/archives/ubuntu-security-announce/$REP_YEAR-$REP_MON/date.html | fgrep '">[USN-'  | cut -d- -f2,3 | cut -d\] -f1))

echo "Fetching USN database..." >&2
if grep -q rookery ~/.ssh/config; then
    rsync -q -e ssh rookery.canonical.com:~ubuntu-security/public_html/usn/database.pickle ./database.pickle
else
    wget -qN http://people.ubuntu.com/~ubuntu-security/usn/database.pickle
fi
PUBLISHED=$(./scripts/report-usn-numbers.py --prose database.pickle $USNS)

# We depend on a script to perform output while the tree is reverted, so
# copy the script out of the tree for later use.
TODO=$(mktemp -t todo-XXXXXX)
cat ./scripts/report-todo-numbers > "$TODO"
chmod u+x "$TODO"

TMP1=$(mktemp -t work1-XXXXXX)
TMP2=$(mktemp -t work2-XXXXXX)
if [ ! -x "scripts/monthly-report" ]; then
    echo "Please run this from the top-level directory of Ubuntu CVE Tracker"
    exit 1
fi

bzr_rewind ()
{
    local changed count

    count=0
    changed="$1"
    while :; do
        bzr revert -r date:"$changed" >/dev/null 2>&1 && break
        changed=$(date +%Y-%m-%d -d "$changed - 1 day")
        count=$(( count + 1 ))
        if [ "$count" -gt 32 ]; then
            echo "Eeek, rewound from $1 past $changed.  Something is wrong."
            exit 1
        fi
    done
    #echo "rewound to $changed"
}


echo "Rewinding bzr tree for stats..." >&2
# Locate the last day something changed
bzr_rewind $(date +%Y-%m-%d -d "$REP_YEAR-$REP_MONN-01 - 1 day")
# Gather stats at the time
./scripts/check-cves --known > "$TMP1"

echo "Fast-forwarding bzr tree for stats..." >&2
# Fast-forward to end of month
bzr revert >/dev/null 2>&1
bzr_rewind $(date +%Y-%m-%d -d "$THIS_YEAR-$THIS_MONN-01 - 1 day")
./scripts/check-cves --known > "$TMP2"
WORK=$($TODO --prose -- -S -E)

echo "Returning bzr tree to present-day..." >&2
# Get back to normal
bzr revert >/dev/null 2>&1

# Calculate difference
TRIAGED=$(diff -u "$TMP1" "$TMP2" | grep '^+CVE' | wc -l)
rm -f "$TMP1" "$TMP2" "$TODO"

# Report!
echo "Subject: Monthly security report for $REP_MON $REP_YEAR"
echo ""
(
echo "The security team had a XXX-level-XXX month.  $PUBLISHED  Additionally, we triaged $TRIAGED public security vulnerability reports, weeding out only those that applied to Ubuntu."
echo ""
echo "$WORK"
) | fmt
