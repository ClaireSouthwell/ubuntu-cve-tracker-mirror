#!/bin/sh

# Author: Jamie Strandboge <jamie@ubuntu.com>
# Author: Kees Cook <kees@ubuntu.com>
# Copyright (C) 2005-2008 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

set -e
#
# Usage:
# ./scripts/cve_status CVE-XXXX-XXXX CVE-XXXX-XXXX
#

if [ "$1" = "-h" ]; then
	echo "./scripts/cve_status [-s] CVE-XXXX-XXXX CVE-XXXX-XXXX ..."
	exit 0
fi

just_status=
if [ "$1" = "-s" ]; then
	shift || true
	just_status="yes"
fi

if [ -z "$1" ]; then
	echo "Need to specify a CVE"
	exit 1
fi

HEADER_SEEN=
for c in "$@"
do
	c=`echo $c | sed 's/,//g'`
	echo "$c" | egrep '^[0-9][0-9][0-9][0-9]\-[0-9][0-9][0-9][0-9]$' >/dev/null 2>&1 && c="CVE-$c"
	echo "$c" | egrep '^(CVE|EMB)-' >/dev/null 2>&1 || continue
	if [ -s "./retired/${c}" ]; then
		echo "$c (retired)"
		if [ -z "$just_status" ]; then
			echo ""
			cat ./retired/$c
			echo ""
		fi
	elif [ -s "./ignored/${c}" ]; then
		echo "$c (ignored)"
		if [ -z "$just_status" ]; then
			echo ""
			cat ./ignored/$c
			echo ""
		fi
	elif fgrep -q "$c" ./ignored/not-for-us.txt ; then
		echo "$c (not for us)"
	elif [ -L "./embargoed" ] && [ -s "./embargoed/$c" ]; then
		echo "$c (embargoed)"
		if [ -z "$just_status" ]; then
			echo ""
			cat ./embargoed/$c
			echo ""
		fi
	elif [ -s "./active/$c" ]; then
		TABLE=$(./scripts/ubuntu-table --supported 2>/dev/null)
		REPORT=$(echo "$TABLE" | egrep "$c")
		LINES=$(echo "$REPORT" | wc -l)
		if [ "$LINES" -gt 0 ] && [ -z "$HEADER_SEEN" ]; then
 			echo "$TABLE" | egrep "[[:space:]]+dapper"
			HEADER_SEEN="yes"
		fi
		echo "$REPORT"
		if [ -z "$just_status" ]; then
			echo ""
			cat ./active/$c
			echo ""
			# Need header again since CVE dump breaks continuity
			HEADER_SEEN=
		fi
	else
		echo "$c (not found)"
	fi
done

