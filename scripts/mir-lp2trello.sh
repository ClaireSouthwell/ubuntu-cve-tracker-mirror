#!/bin/bash

TRELLO_BOARD="Security Team"
TRELLO_LANE="MIR backlog"
TRELLO_EXCLUDE_LANES="Completed,DONE"
COV_URL="http://10.246.74.221:8079"
SRCS=$($UCT/scripts/report-todo-mir | awk '/^=== Source: / {print $3}')

echo $SRCS

for SRC in $SRCS ; do
    echo "package $SRC found in report-todo-mir output"
    CARD=$($UCT/scripts/trello_lib.py --board "$TRELLO_BOARD" --find $SRC)
    if [[ -n "$CARD" ]] ; then
        echo "found existing MIR trello card for $SRC in the $TRELLO_LANE lane on the $TRELLO_BOARD trello board"
    else
	TD=$(mktemp -d)
	cd $TD
	echo "Running uaudit $SRC in $TD and creating new trello card for $SRC in the $TRELLO_LANE lane on the $TRELLO_BOARD trello board"
        uaudit $SRC
        $UCT/scripts/trello_lib.py --board "$TRELLO_BOARD" --lane "$TRELLO_LANE" --new "[MIR] $SRC" "$SRC coverity scan results uploaded to $COV_URL"
    fi
done
