;;; uct -- Emacs interface to the Ubuntu CVE tracker

;;; Commentary:

;;; Code:
(require 'cl-lib)
(require 'subr-x)
(require 'cve-mode)

(defgroup uct nil
  "UCT for Emacs"
  :group 'applications)

(defcustom uct-default-directories '("active" "embargoed")
  "The default list of directories from which to load CVEs."
  :type '(repeat string)
  :group 'uct)

(defvar uct-cve-regex cve-mode-cve-id-regexp)

(defvar uct-supported-releases '(trusty xenial bionic cosmic devel))

(defvar uct-directories nil)

(defvar uct-filtered-package nil)

(defvar uct-cves nil)

(defconst uct-base-path
  (file-name-directory
   (directory-file-name
    (file-name-directory
     (file-truename
      (expand-file-name
       (or load-file-name buffer-file-name)))))))

(cl-defstruct (cve)
  id
  description
  priority
  package
  status
  file)

(defun uct--flatten (l)
  "Flatten list L."
  (cond ((null l) l)
        ((listp l) (append (uct--flatten (car l)) (uct--flatten (cdr l))))
        (t (list l))))

(defun uct-load-cves-from-file (file)
  "Load all CVEs from FILE and return `cve' objects or nil on error."
  (let (id description priority packages)
    (with-temp-buffer
      (insert-file-contents file)
      (goto-char (point-min))
      (save-excursion
        (if (re-search-forward (concat "^Candidate: *" uct-cve-regex) nil t)
            (setq id (intern (match-string 1)))
          (error "%s does not appear to be a valid CVE" file)))
      (save-excursion
        (setq description
              (if (re-search-forward "^Description: *" nil t)
                  (let ((start (point))
                        (end (progn
                               (re-search-forward "^[A-Z]")
                               (forward-line -1)
                               (end-of-line)
                               (point))))
                    (replace-regexp-in-string "\n" " "
                     (string-trim (buffer-substring-no-properties start end))))
                "")))
      (save-excursion
        (if (re-search-forward cve-mode-priority-regexp nil t)
            (setq priority (intern (match-string 1)))
          (setq priority '-)))
      (while (re-search-forward cve-mode-releases-regexp nil t)
        (let* ((release (intern (match-string 2)))
               (package (intern (match-string 3)))
               (status (intern (or (match-string 4) "untriaged")))
               (entry (assoc package packages))
               (statuses (cdr entry)))
          (if entry
              (setf (cdr entry)
                    (add-to-list 'statuses `(,release . ,status)))
            (add-to-list 'packages `(,package . ,statuses)))))
      (mapcar #'(lambda (pkg)
                  (make-cve :id id
                            :description description
                            :priority priority
                            :package (car pkg)
                            :status (cdr pkg)
                            :file file))
              packages))))

(defun uct-find-cves (dir)
  "Return all CVEs found in DIR."
  (let* ((cves nil)
         (i 0)
         (files (directory-files dir t uct-cve-regex))
         (progress (make-progress-reporter "Loading CVEs..." 1 (length files))))
    (dolist (file files)
      (cl-incf i)
      (progress-reporter-update progress i)
      (dolist (cve (uct--flatten (uct-load-cves-from-file file)))
        (push cve cves)))
    (progress-reporter-done progress)
    cves))

(defface uct-list-face-cve-active
  '((t :inherit font-lock-function-name-face))
  "Face used on the status of CVEs.")

(defface uct-list-face-cve-embargoed
  '((t :inherit error))
  "Face used on the status of CVEs.")

(defface uct-list-face-cve-retired
  '((t :inherit font-lock-comment-face))
  "Face used on the status of CVEs.")

(defun uct-list--face-for-cve (cve)
  "Return face for CVE."
  (let ((dir (file-name-base
              (directory-file-name
               (file-name-directory (cve-file cve))))))
    (pcase dir
      (`"active" 'uct-list-face-cve-active)
      (`"embargoed" 'uct-list-face-cve-embargoed)
      (`"retired" 'uct-list-face-cve-retired)
      (_ 'font-lock-warning-face))))

(defface uct-list-face-priority-critical
  '((t :inherit error))
  "Face used on the status of CVEs.")

(defface uct-list-face-priority-high
  '((t :inherit font-lock-warning-face))
  "Face used on the status of CVEs.")

(defface uct-list-face-priority-medium
  '((t :inherit default))
  "Face used on the status of CVEs.")

(defface uct-list-face-priority-low
  '((t :inherit font-lock-comment-face))
  "Face used on the status of CVEs.")

(defface uct-list-face-priority-negligible
  '((t :inherit font-lock-comment-face))
  "Face used on the status of CVEs.")

(defun uct-list--face-for-priority (priority)
  "Return face for PRIORITY."
  (pcase priority
    (`critical 'uct-list-face-priority-critical)
    (`high 'uct-list-face-priority-high)
    (`medium 'uct-list-face-priority-medium)
    (`low 'uct-list-face-priority-low)
    (`negligible 'uct-list-face-priority-negligible)
    (_ 'font-lock-warning-face)))

(defface uct-list-face-status-dne
  '((t :inherit font-lock-comment-face))
  "Face used on the status of CVEs.")

(defface uct-list-face-status-not-affected
  '((t :inherit font-lock-comment-face))
  "Face used on the status of CVEs.")

(defface uct-list-face-status-needs-triage
  '((t :inherit default))
  "Face used on the status of CVEs.")

(defface uct-list-face-status-needed
  '((t :inherit font-lock-warning-face))
  "Face used on the status of CVEs.")

(defface uct-list-face-status-deferred
  '((t :inherit font-lock-builtin-face))
  "Face used on the status of CVEs.")

(defface uct-list-face-status-pending
  '((t :inherit font-lock-function-name-face))
  "Face used on the status of CVEs.")

(defface uct-list-face-status-released
  '((t :inherit font-lock-keyword-face))
  "Face used on the status of CVEs.")

(defun uct-list--face-for-status (status)
  "Return face for STATUS."
  (pcase status
    (`DNE 'uct-list-face-status-dne)
    (`not-affected 'uct-list-face-status-not-affected)
    (`needs-triage 'uct-list-face-status-needs-triage)
    (`needed 'uct-list-face-status-needed)
    (`deferred 'uct-list-face-status-deferred)
    (`pending 'uct-list-face-status-released)
    (`released 'uct-list-face-status-released)
    (_ 'font-lock-warning-face)))

(defun uct-list-load-entry (&optional button)
  "Load a CVE from the CVE list.
If optional arg BUTTON is non-nil, describe it's associated CVE."
  (interactive)
   (unless (derived-mode-p 'uct-list-mode)
     (error "The current buffer is not in UCT List Mode"))
   (let ((cve (if button (button-get button 'cve)
               (tabulated-list-get-id))))
    (if cve
        (find-file-other-window (cve-file cve))
      (user-error "No CVE here"))))

(defun uct-list--list-entry (cve)
  "Return a CVE entry suitable for `tabulated-list-entries'.
CVE is a `cve' object."
  (list cve
        `[(,(symbol-name (cve-id cve))
           face ,(uct-list--face-for-cve cve)
           follow-link t
           cve ,cve
           action uct-list-load-entry)
          ,(symbol-name (cve-package cve))
          ,(propertize (symbol-name (cve-priority cve))
                       'font-lock-face
                       (uct-list--face-for-priority (cve-priority cve)))
          ,@(mapcar #'(lambda (release)
                        (let ((status (or (cdr (assoc release (cve-status cve))) '-)))
                          (propertize (symbol-name status)
                                      'font-lock-face
                                      (uct-list--face-for-status status))))
                    uct-supported-releases)
          ,(propertize (cve-description cve)
                       'font-lock-face 'font-lock-string-face)]))

(defun uct-list--status-needed (cve)
  "Whether CVE has any status where work is needed."
  (cl-notevery #'null
             (mapcar #'(lambda (release)
                         (let ((status (or (cdr (assoc release (cve-status cve))) '-)))
                           (memq status '(needs-triage needed deferred pending))))
                     uct-supported-releases)))

(defun uct-list--visible (cve)
  "Whether CVE should be visible in list or not."
  (and
   (or (null uct-filtered-package)
       (eql uct-filtered-package (cve-package cve)))
   (uct-list--status-needed cve)))

(defun uct-list-refresh (&optional dirs)
  "Refresh the list of CVEs for DIRS.
If DIRS is not specified, use the value of `uct-default-directories'."
  (interactive)
  (unless (derived-mode-p 'uct-list-mode)
    (error "The current buffer is not in UCT List Mode"))
  (unless dirs
    (setq dirs uct-default-directories))
  (unless (listp dirs)
    (setq dirs (list dirs)))
  (tabulated-list-init-header)
  ;; don't try and mapcar as run out of stack depth - accumulate and
  ;; process
  (let (entries)
    (when (not (equal dirs uct-directories))
      (message "Resetting uct-directories to %S" dirs)
      (setq uct-directories dirs)
      (setq uct-cves nil))
    (unless uct-cves
      (message "Loading CVEs from %s..." (mapconcat #'identity uct-directories ", "))
      (dolist (dir (mapcar #'(lambda (d) (expand-file-name d uct-base-path))
                           uct-directories))
        (dolist (cve (uct-find-cves dir))
          (push cve uct-cves))))
    (dolist (cve uct-cves)
      (when (uct-list--visible cve)
        (push (uct-list--list-entry cve) entries)))
    (setq tabulated-list-entries entries)))

(defun uct-list--id-predicate (A B)
  "Sort predicate for CVE on ID between A and B."
  (string< (cve-id (car A)) (cve-id (car B))))

(defvar uct-list--priorities '(negligible low medium high critical))

(defun uct-list--priority-predicate (A B)
  "Sort predicate for CVE priority between A and B."
  (< (or (cl-position (cve-priority (car A)) uct-list--priorities) -1)
     (or (cl-position (cve-priority (car B)) uct-list--priorities) -1)))

(defun uct-list--get-packages ()
  "Return the list of packages from the current list of CVEs."
  (let (packages)
    (dolist (cve uct-cves)
      (let ((package (cve-package cve)))
        (unless (member package packages)
          (push package packages))))
    packages))

(defun uct-list-filter-by-package (&optional package)
  "Filter the list of CVEs to only those affecting PACKAGE."
  (interactive
   (list (completing-read "Package: " (uct-list--get-packages))))
   (unless (derived-mode-p 'uct-list-mode)
     (error "The current buffer is not in UCT List Mode"))
   (when (stringp package)
    (if (string= package "")
        (setq package nil)
      (setq package (intern package))))
  (setq uct-filtered-package package)
  (tabulated-list-revert))

(defun uct-list-filter-by-this-package ()
  "Filter the list of CVEs to only the package affecting the current line CVE."
  (interactive)
   (unless (derived-mode-p 'uct-list-mode)
     (error "The current buffer is not in UCT List Mode"))
  (let* ((cve (tabulated-list-get-id))
          (package (if cve (symbol-name (cve-package cve)))))
    (if package (uct-list-filter-by-package package))))

(defvar uct-list-mode-map
  (let ((map (make-sparse-keymap)))
    (set-keymap-parent map tabulated-list-mode-map)
    (define-key map "\C-m" 'uct-list-load-entry)
    (define-key map "r" 'uct-list-refresh)
    (define-key map "p" 'uct-list-filter-by-package)
    (define-key map "P" 'uct-list-filter-by-this-package)
    map)
  "Local keymap for `uct-list-mode' buffers.")

;;;###autoload
(define-derived-mode uct-list-mode tabulated-list-mode "CVEs"
  "Major mode for browsing CVEs.
\\<uct-list-mode-map>
\\{uct-list-mode-map}"
  (setq tabulated-list-format `[("CVE" 17 uct-list--id-predicate)
                                ("Package" 18 t)
                                ("Priority" 10 uct-list--priority-predicate)
                                ,@(mapcar #'(lambda (release)
                                              (list (symbol-name release) 12 nil))
                                          uct-supported-releases)
                                ("Description" 0 nil)])
  (setq tabulated-list-sort-key (cons "CVE" nil))
  (add-hook 'tabulated-list-revert-hook #'uct-list-refresh nil t)
  (tabulated-list-init-header))

;;;###autoload
(defun uct (&optional dirs)
  "Display list of CVEs for DIRS (if not set will show all active and embargoed)."
  (interactive)
  (unless dirs
    (setq dirs (list "active" "embargoed")))
  (let ((buffer (get-buffer-create "*UCT*")))
    (with-current-buffer buffer
      (uct-list-mode)
      (uct-list-refresh dirs)
      (message "Displaying CVEs...")
      (tabulated-list-print))
    (switch-to-buffer buffer)))

;;;###autoload
(defun uct-embargoed ()
  "Display list of embargoed CVEs."
  (interactive)
  (uct (list "embargoed")))

;;;###autoload
(defun uct-cve-at-point ()
  "Return the CVE at point or nil if none found."
  (let ((cve (thing-at-point 'symbol t)))
    (when (or (null cve) (not (string-match uct-cve-regex cve)))
      (save-excursion
        (let ((end (save-excursion (forward-line) (point))))
          (backward-word)
          (if (re-search-forward uct-cve-regex end t)
              (setq cve (substring-no-properties (match-string 1)))
            (setq cve nil)))))
    cve))

;;;###autoload
(defun uct-find-cve (&optional cve)
  "Open the specified CVE file from UCT (or if no CVE use the one at point)."
  (interactive (list (or (uct-cve-at-point) (read-string "CVE: "))))
  (let ((dirs '("active" "retired" "ignored" "embargoed")))
    (when (and cve (string-match uct-cve-regex cve))
      (let ((cve-file (car (cl-remove-if #'null
                                         (mapcar #'(lambda (dir)
                                                     (let ((file (format "%s/%s/%s" uct-base-path dir cve)))
                                                       (when (file-exists-p file)
                                                         file)))
                                                 dirs)))))
        (if cve-file
            (find-file-other-window cve-file)
          (user-error "Unable to find %s in UCT" cve))))))

(provide 'uct)
;;; uct.el ends here
