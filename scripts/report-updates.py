#!/usr/bin/env python
#
# This script reports how many "updates" (CVEs per package per USN)
# happen per month and per year.
#
# Copyright (C) 2008-2015 Canonical, Ltd
# Author: Kees Cook <kees@ubuntu.com>
import cve_lib
import optparse
import os
import sys
import time
import usn_lib

config = cve_lib.read_config()
default_db = config['usn_db_copy']
if '-all' not in default_db:
    tmp = os.path.splitext(default_db)
    if len(tmp) == 2:
        default_db = "%s-all%s" % (tmp[0], tmp[1])

parser = optparse.OptionParser()
parser.add_option("--with-eol", help="Also show those CVEs in EOL releases", action="store_true", default=False)
parser.add_option("--db", help="Specify the USN database to load", metavar="FILENAME", default=default_db)
(opt, args) = parser.parse_args()

reverted = usn_lib.get_reverted()

if not os.path.exists(opt.db):
    print >>sys.stderr, "Cannot read %s" % (opt.db)
    sys.exit(1)
db = usn_lib.load_database(opt.db)

releases = cve_lib.releases
if opt.with_eol is False:
    for eol in cve_lib.eol_releases:
         if eol in releases:
             releases.remove(eol)

def report(epoch, usn, cve, pkg, rel):
    print '%s: %s: %s: %s (%s)' % (time.strftime("%Y-%m-%d",time.gmtime(epoch)),usn, cve, pkg, rel)

for usn in db:
    cves = []
    if not db[usn].has_key('cves'):
        #print >>sys.stderr, "Skipped USN lacking 'cves': %s" % (usn)
        cves = ['unknownCVE']
    else:
        cves = db[usn]['cves']

    for cve in cves:
        if ' CVE' in cve:
            print >>sys.stderr, "Bad CVE name (%s) in USN-%s" % (cve, usn)
        #if not cve.startswith('CVE-'):
        #    print >>sys.stderr, "Skipped weird CVE in USN-%s: %s" % (usn,cve)
        #    continue
        ## Skip checking CVEs that were reverted for a given USN
        #if reverted.has_key(usn) and cve in reverted[usn]:
        #    continue

        for rel in db[usn]['releases']:
            if rel not in releases:
                continue

            if not db[usn]['releases'][rel].has_key('sources'):
                if not db[usn]['releases'][rel].has_key('archs'):
                    # Old USN, lacks either sources or archs, use first binary
                    pkg = db[usn]['releases'][rel]['binaries'].keys()[0]
                    report(db[usn]['timestamp'],usn, cve, pkg, rel)
                else:
                    for filename in db[usn]['releases'][rel]['archs']['source']['urls'].keys():
                        if filename.endswith('.dsc'):
                            pkg = filename.split('/').pop().split('_').pop(0)
                            report(db[usn]['timestamp'],usn, cve, pkg, rel)
            else:
                for pkg in db[usn]['releases'][rel]['sources']:
                    report(db[usn]['timestamp'],usn, cve, pkg, rel)

