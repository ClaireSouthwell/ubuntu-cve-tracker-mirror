#!/bin/bash
# Copyright (C) 2018 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

# Sends the current CVE backlog to prometheus for the KPIs
set -e

# move into the directory which contains this script
pushd $(dirname "${BASH_SOURCE[0]}")

# Open CVEs
pushd ..
./scripts/report-todo-plot -S | while read -r critical high medium low _
do
  # TODO - why only if medium != 0? this was here when I (amurray) got here and
  # I don't have the context to know why...?
  if [ "$medium" -ne 0 ]; then
    for level in critical high medium low; do
      n=${!level}
      echo "Pushing $n $level CVEs backlog to Prometheus"
      echo "security_cve_backlog_daily $n" | curl -s --data-binary @- http://push.security.kpi.internal:9091/metrics/job/security_usns_job/instance/$level
    done
  fi
done
popd
popd
