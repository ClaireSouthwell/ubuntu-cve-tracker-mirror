#!/bin/sh
# Copyright 2009 Canonical, Ltd.
# Author: Jamie Strandboge <jamie@canonical.com>
#
# Script to help triage CVEs based on Triage Frequency in $UCT/README
#

set -e

uctconf="$HOME/.ubuntu-cve-tracker.conf"
if [ -s "$uctconf" ]; then
    . "$uctconf"
else
    echo "Could not find '$uctconf'" >&2
    exit 1
fi

download() {
    url="$1"
    # if http, then download it with wget, otherwise, try to rsync it
    if echo "$url" | grep -q "^http" ; then
        echo "wget -N \"$url\""
        wget -N "$url"
    else
        echo "rsync -v --progress \"$url\" ."
        rsync -v --progress "$url" .
    fi
    echo "---"
}

update_files() {
    download "$mitre_loc/allitems.xml"
    download "$nvd_loc/nvdcve-2*.xml"
    download "http://nvd.nist.gov/download/nvdcve-recent.xml"
}

full_refresh() {
    # get PubDate
    echo "update PubDate (check-cves --refresh nvdcve-*.xml) ..."
    ./scripts/check-cves --refresh nvdcve-*.xml

    # get authoritative descriptions
    echo "get authoritative descriptions (check-cves --refresh ./allitems.xml) ..."
    ./scripts/check-cves --refresh ./allitems.xml
}

kernel_team_merge() {
    echo "Merging with kernel team CVE tracker"
    bzr merge lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team
}

prev_dir=`pwd`
trap "cd '$prev_dir'" EXIT HUP INT QUIT TERM

# Update Debian SVN
if [ -n "$secure_testing_path" ] && [ -d "${secure_testing_path}/.svn" ] ; then
    echo "Updating '$secure_testing_path'"
    cd "$secure_testing_path"
    svn update
fi

cd ${UCT}

# Determine mode
action=`LC_TIME=C date +%a`
if [ ! -z "$1" ]; then
    action="$1"
fi

update_files

case "$action" in
    Mon)
        kernel_team_merge
        echo "check-cves nvdcve-*.xml"
        ./scripts/check-cves nvdcve-*.xml
        ;;
    Wed)
        kernel_team_merge
        full_refresh

        # process new ones
        echo "check-cves ./nvdcve-recent.xml"
        ./scripts/check-cves ./nvdcve-recent.xml
        echo "check-cves ./allitems.xml"
        ./scripts/check-cves ./allitems.xml

        full_refresh
        ;;
    update)
        # Do no triage
        ;;
    refresh)
        # Do no triage
        full_refresh
        ;;
    *)
        kernel_team_merge
        echo "check-cves ./nvdcve-recent.xml"
        ./scripts/check-cves ./nvdcve-recent.xml
        ;;
esac

exit 0
